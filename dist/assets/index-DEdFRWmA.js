var sn=Object.defineProperty;var an=(e,t,n)=>t in e?sn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var be=(e,t,n)=>an(e,typeof t!="symbol"?t+"":t,n);import{R as F,r as d,j as o,a as pe,f as Tt,C as cn}from"./three-fiber-BZljtFsf.js";import{u as Ie,S as ae,a as Fe,b as ln,L as un,H as dn,G as fn,E as hn,T as mn,c as pn}from"./three-drei-enWTNQzH.js";import{v as C,e as K,q as G,u as It,R as Ft,C as xn,P as gn}from"./three-rapier-DEjDsxOq.js";import{d as Z,P as Lt,ah as Ut,ar as Gt,ab as xe,M as Xt,a7 as yn,R as ct,v as vn}from"./three-core-Bc71Y2F5.js";import"./physics-engine-CmnDU9Yz.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();var Bt={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},lt=F.createContext&&F.createContext(Bt),bn=["attr","size","title"];function wn(e,t){if(e==null)return{};var n=jn(e,t),r,i;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)r=s[i],!(t.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}function jn(e,t){if(e==null)return{};var n={};for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){if(t.indexOf(r)>=0)continue;n[r]=e[r]}return n}function le(){return le=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},le.apply(this,arguments)}function ut(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function ue(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?ut(Object(n),!0).forEach(function(r){Sn(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ut(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}function Sn(e,t,n){return t=Cn(t),t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Cn(e){var t=Rn(e,"string");return typeof t=="symbol"?t:t+""}function Rn(e,t){if(typeof e!="object"||!e)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var r=n.call(e,t);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function Wt(e){return e&&e.map((t,n)=>F.createElement(t.tag,ue({key:n},t.attr),Wt(t.child)))}function kn(e){return t=>F.createElement(Pn,le({attr:ue({},e.attr)},t),Wt(e.child))}function Pn(e){var t=n=>{var{attr:r,size:i,title:s}=e,c=wn(e,bn),a=i||n.size||"1em",l;return n.className&&(l=n.className),e.className&&(l=(l?l+" ":"")+e.className),F.createElement("svg",le({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},n.attr,r,c,{className:l,style:ue(ue({color:e.color||n.color},n.style),e.style),height:a,width:a,xmlns:"http://www.w3.org/2000/svg"}),s&&F.createElement("title",null,s),e.children)};return lt!==void 0?F.createElement(lt.Consumer,null,n=>t(n)):t(Bt)}function dt(e){return kn({attr:{viewBox:"0 0 384 512"},child:[{tag:"path",attr:{d:"M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0zM192 272c44.183 0 80-35.817 80-80s-35.817-80-80-80-80 35.817-80 80 35.817 80 80 80z"},child:[]}]})(e)}function ft(e,t,n){return Math.sqrt(Math.pow(e.x-t.x,2)+n+Math.pow(e.z-t.z,2))}function On(e){const t=k(0,0,1),n=Math.acos(e.dot(t)/e.length()),r=e.cross(t),i=Math.sin(r.y)||1;return Math.PI-n*i}const k=(e=0,t=0,n=0)=>new Z(e,t,n),T={activeState:{position:k(0,5,5),impulse:C(),velocity:C(),acceleration:C(),quat:G(),euler:K(),rotation:K(),dir:C(),direction:C()},mode:{},urls:{characterUrl:null,vehicleUrl:null,airplaneUrl:null,wheelUrl:null,ridingUrl:null},states:{rideableId:null,isMoving:!1,isNotMoving:!1,isOnTheGround:!1,isOnMoving:!1,isRotated:!1,isRunning:!1,isJumping:!1,enableRiding:!1,isRiderOn:!1,isLanding:!1,isFalling:!1,isRiding:!1,isPush:{forward:!1,backward:!1,leftward:!1,rightward:!1}},minimap:{props:{}},clicker:{point:k(0,0,0),angle:Math.PI/2,isOn:!1,isRun:!1},control:{forward:!1,backward:!1,leftward:!1,rightward:!1},animationState:{character:{current:"idle",default:"idle",store:{}},vehicle:{current:"idle",default:"idle",store:{}},airplane:{current:"idle",default:"idle",store:{}}},cameraOption:{offset:k(-10,-10,-10),maxDistance:-7,distance:-1,XDistance:20,YDistance:10,ZDistance:20,zoom:1,target:C(),position:C(),focus:!1},rideable:{},sizes:{},block:{camera:!1,control:!1,animation:!1,scroll:!0},clickerOption:{isRun:!0,throttle:100,autoStart:!1,track:!1,loop:!1,queue:[],line:!1}},A=d.createContext(null),X=d.createContext(null),Le=d.forwardRef(({children:e},t)=>o.jsx("group",{ref:t,userData:{intangible:!0},children:e}));function de({type:e}){const{animationState:t}=d.useContext(A),n=d.useContext(X),r=d.useCallback(()=>{let a=t[e].default;const l=t[e].store;for(const u of Object.keys(l)){const h=l[u];if(h!=null&&h.condition()){a=h.animationName||u;break}}return t[e].current!==a&&(t[e].current=a,n({type:"update",payload:{animationState:{...t,[e]:{...t[e],current:a}}}})),a},[t,e,n]),i=d.useCallback(a=>{delete t[e].store[a],n({type:"update",payload:{animationState:{...t,[e]:{...t[e],store:{...t[e].store}}}}})},[t,e,n]),s=d.useCallback(({tag:a,condition:l,action:u,animationName:h,key:f})=>{const p=t[e].store[a],g={tag:a,condition:l,action:u||(()=>{}),animationName:h||a,key:f||a};p&&p.tag===a&&p.animationName===h||(t[e].store[a]=g,n({type:"update",payload:{animationState:{...t,[e]:{...t[e],store:{...t[e].store,[a]:g}}}}}))},[t,e,n]),c=d.useCallback(a=>{const l=[],u={...t[e].store};let h=!1;return a.forEach(f=>{const p=u[f.tag],g={tag:f.tag,condition:f.condition,action:f.action,animationName:f.animationName,key:f.key};(!p||p.animationName!==f.animationName||p.tag!==f.tag)&&(u[f.tag]=g,h=!0),l.push(f.tag)}),h&&n({type:"update",payload:{animationState:{...t,[e]:{...t[e],store:u}}}}),()=>{const f={...t[e].store};l.forEach(p=>{delete f[p]}),n({type:"update",payload:{animationState:{...t,[e]:{...t[e],store:f}}}})}},[t,e,n]);return{subscribe:s,subscribeAll:c,store:t==null?void 0:t[e].store,unsubscribe:i,notify:r}}function Mn({type:e}){const{states:t}=d.useContext(A),{subscribeAll:n}=de({type:e});d.useEffect(()=>{n([{tag:"walk",condition:()=>!t.isRunning&&t.isMoving,action:()=>{},animationName:"walk",key:"walk"},{tag:"run",condition:()=>t.isRunning,action:()=>{},animationName:"run",key:"run"},{tag:"jump",condition:()=>t.isJumping,action:()=>{},animationName:"jump",key:"jump"},{tag:"ride",condition:()=>t.isPush.keyR,action:()=>{},animationName:"ride",key:"ride"},{tag:"land",condition:()=>t.isLanding,action:()=>{},animationName:"land",key:"land"},{tag:"fall",condition:()=>t.isFalling,action:()=>{},animationName:"fall",key:"fall"}])},[])}function Ue({type:e,actions:t,animationRef:n,currentAnimation:r,isActive:i}){var p,g;const{mode:s,animationState:c,block:a}=d.useContext(A),l=d.useContext(X),{notify:u,store:h}=de({type:e});i&&(r=(p=c==null?void 0:c[e])==null?void 0:p.current);const f=b=>{c[e].current=b;const y=h[b];y!=null&&y.action&&y.action(),l({type:"update",payload:{animationState:{...c}}})};return d.useEffect(()=>{var R;let b="idle";a.animation?b="idle":r?b=r:c[e].current&&(b=c[e].current);const y=(R=t[b])==null?void 0:R.reset().fadeIn(.2).play();return()=>{y==null||y.fadeOut(.2)}},[r,s.type,a.animation,e]),pe(()=>{if(i){const b=u();f(b)}}),{animationRef:n,currentAnimation:(g=c==null?void 0:c[e])==null?void 0:g.current}}class Dn{constructor(){be(this,"subscriptions",new Map);be(this,"isRunning",!1)}subscribe(t,n,r=0){this.subscriptions.set(t,{id:t,callback:n,priority:r})}unsubscribe(t){this.subscriptions.delete(t)}executeFrame(t,n){if(!this.isRunning){this.isRunning=!0;try{const r=Array.from(this.subscriptions.values()).sort((i,s)=>i.priority-s.priority);for(const i of r)try{i.callback(t,n)}catch(s){console.error(`Frame callback error for ${i.id}:`,s)}}finally{this.isRunning=!1}}}getSubscriptionCount(){return this.subscriptions.size}}const ce=new Dn;function ge(e,t,n=0,r=!0){const i=d.useRef(t);i.current=t;const s=d.useCallback((l,u)=>{r&&i.current(l,u)},[r]),c=d.useCallback(()=>{ce.subscribe(e,s,n)},[e,s,n]),a=d.useCallback(()=>{ce.unsubscribe(e)},[e]);return d.useEffect(()=>(c(),a),[c,a]),{subscriptionCount:ce.getSubscriptionCount()}}function An(){pe((e,t)=>{ce.executeFrame(e,t)})}const Zt=(e,t)=>{const n=t.xDistance??t.XDistance??20,r=t.yDistance??t.YDistance??10,i=t.zDistance??t.ZDistance??20;return e.position.clone().add(k(n,r,i))},En=(e,t,n)=>{if(!n.enableCollision)return e;const r=e.clone().sub(t).normalize(),i=e.distanceTo(t),s=Math.abs(n.maxDistance??-7)*.3;return i<s?t.clone().add(r.multiplyScalar(s)):e},_n=(e,t)=>{if(!t.bounds)return e;const{bounds:n}=t,r=e.clone();return n.minX!==void 0&&(r.x=Math.max(r.x,n.minX)),n.maxX!==void 0&&(r.x=Math.min(r.x,n.maxX)),n.minY!==void 0&&(r.y=Math.max(r.y,n.minY)),n.maxY!==void 0&&(r.y=Math.min(r.y,n.maxY)),n.minZ!==void 0&&(r.z=Math.max(r.z,n.minZ)),n.maxZ!==void 0&&(r.z=Math.min(r.z,n.maxZ)),r},Nn=(e,t,n,r)=>{const i=e.distanceTo(t),s=Math.abs(r.maxDistance??-7),c=Math.min(i/s,2);return Math.min(n*c,.3)};function ht(e){var l,u;const{state:t,worldContext:{cameraOption:n,activeState:r},controllerOptions:{lerp:i}}=e;if(!t||!t.camera)return;let s=Zt(r,n);s=En(s,r.position,n),s=_n(s,n);const c=((l=n.smoothing)==null?void 0:l.position)??Nn(t.camera.position,s,i.cameraPosition,n);t.camera.position.lerp(s,c);const a=n.target||r.position;if(t.camera.lookAt(a),n.fov&&t.camera instanceof Lt){const h=n.fov,f=t.camera.fov,p=((u=n.smoothing)==null?void 0:u.fov)??.1;t.camera.fov=Ut.lerp(f,h,p),t.camera.updateProjectionMatrix()}}const zn=(e,t)=>{const n=t.xDistance??t.XDistance??20,r=t.yDistance??t.YDistance??10,i=t.zDistance??t.ZDistance??20;return e.position.clone().add(k(Math.sin(e.euler.y),1,Math.cos(e.euler.y)).normalize().clone().multiply(k(-n,r,-i)))},Tn=(e,t,n=.1)=>{const r=t.quat.clone().multiply(G().setFromAxisAngle(k(0,1,0),Math.PI));e.quaternion&&e.quaternion.slerp(r,n)};function In(e){var a,l;const{state:t,worldContext:{activeState:n,cameraOption:r},controllerOptions:{lerp:i}}=e;if(!t||!t.camera)return;const s=zn(n,r),c=((a=r.smoothing)==null?void 0:a.position)??i.cameraTurn;t.camera.position.lerp(s.clone(),c),(l=r.smoothing)!=null&&l.rotation?Tn(t.camera,n,r.smoothing.rotation):(t.camera.quaternion.copy(n.quat.clone().multiply(G().setFromAxisAngle(k(0,1,0),Math.PI))),t.camera.rotation.copy(n.euler)),t.camera.lookAt(n.position.clone())}const Fn=(e,t)=>{const n=t.yDistance??t.YDistance??1.6;return e.position.clone().add(k(0,n,0))};function Ln(e){var a,l;const{state:t,worldContext:{cameraOption:n,activeState:r},controllerOptions:{lerp:i}}=e;if(!t||!t.camera)return;const s=Fn(r,n),c=((a=n.smoothing)==null?void 0:a.position)??i.cameraPosition;if(t.camera.position.lerp(s,c),t.camera.rotation.copy(r.euler),n.fov&&t.camera instanceof Lt){const u=n.fov,h=t.camera.fov,f=((l=n.smoothing)==null?void 0:l.fov)??.1;t.camera.fov=Ut.lerp(h,u,f),t.camera.updateProjectionMatrix()}}const Un=(e,t)=>{const n=Math.abs(t.yDistance??t.YDistance??20),r=t.xDistance??t.XDistance??0,i=t.zDistance??t.ZDistance??0;return e.position.clone().add(k(r,n,i))},Gn=(e,t)=>{if(!t)return e;const n=e.clone();return t.minX!==void 0&&(n.x=Math.max(n.x,t.minX)),t.maxX!==void 0&&(n.x=Math.min(n.x,t.maxX)),t.minZ!==void 0&&(n.z=Math.max(n.z,t.minZ)),t.maxZ!==void 0&&(n.z=Math.min(n.z,t.maxZ)),n};function Xn(e){var l;const{state:t,worldContext:{cameraOption:n,activeState:r},controllerOptions:{lerp:i}}=e;if(!t||!t.camera)return;let s=Un(r,n);n.bounds&&(s=Gn(s,{minX:n.bounds.minX,maxX:n.bounds.maxX,minZ:n.bounds.minZ,maxZ:n.bounds.maxZ}));const c=((l=n.smoothing)==null?void 0:l.position)??i.cameraPosition;t.camera.position.lerp(s,c),t.camera.rotation.set(-Math.PI/2,0,0);const a=r.position.clone();a.y=0,t.camera.lookAt(a)}const Bn=(e,t)=>{const n=t.xDistance??t.XDistance??-15,r=t.yDistance??t.YDistance??5,i=e.position.z;return k(e.position.x+n,e.position.y+r,i)},Wn=(e,t)=>{if(!t)return e;const n=e.clone();return t.minX!==void 0&&(n.x=Math.max(n.x,t.minX)),t.maxX!==void 0&&(n.x=Math.min(n.x,t.maxX)),t.minY!==void 0&&(n.y=Math.max(n.y,t.minY)),t.maxY!==void 0&&(n.y=Math.min(n.y,t.maxY)),n};function Zn(e){var l;const{state:t,worldContext:{cameraOption:n,activeState:r},controllerOptions:{lerp:i}}=e;if(!t||!t.camera)return;let s=Bn(r,n);n.bounds&&(s=Wn(s,{minX:n.bounds.minX,maxX:n.bounds.maxX,minY:n.bounds.minY,maxY:n.bounds.maxY}));const c=((l=n.smoothing)==null?void 0:l.position)??i.cameraPosition;t.camera.position.lerp(s,c),t.camera.rotation.set(0,0,0);const a=r.position.clone();t.camera.lookAt(a)}function Kn(e){ge(`camera-${e.worldContext.mode.control}`,t=>{if(e.state=t,!e.worldContext.block.camera)switch(e.worldContext.mode.control){case"firstPerson":Ln(e);break;case"thirdPerson":case"normal":ht(e);break;case"thirdPersonOrbit":case"orbit":In(e);break;case"topDown":Xn(e);break;case"sideScroll":Zn(e);break;default:ht(e);break}e.worldContext.cameraOption.focus||(e.worldContext.cameraOption.target=e.worldContext.activeState.position,e.worldContext.cameraOption.position=Zt(e.worldContext.activeState,e.worldContext.cameraOption))},1,!e.worldContext.block.camera)}function Yn({props:e,actions:t,componentType:n}){const{animationState:r}=d.useContext(A),i=d.useContext(X),{store:s}=de({type:n}),{activeState:c,states:a,control:l}=d.useContext(A),{subscribe:u}=de({type:n}),h=d.useCallback((g,b)=>{if(b in l&&l[b]&&r[n]&&r[n].current!==g){r[n].current=g;const R=s[g];R!=null&&R.action&&R.action(),i({type:"update",payload:{animationState:{...r,[n]:{...r[n],current:g}}}})}},[l,r,n,s,i]),f=d.useMemo(()=>({activeState:c,control:l,states:a,subscribe:u}),[c,l,a,u]);d.useEffect(()=>(e.onReady&&e.onReady(f),()=>{e.onDestory&&e.onDestory(f)}),[e.onReady,e.onDestory,f]);const p=d.useMemo(()=>({...f,actions:t,animationState:r,playAnimation:h}),[f,t,r,h]);return ge(`callback-${n}`,g=>{e.onFrame&&e.onFrame({...f,...g}),e.onAnimate&&e.onAnimate({...p,...g})},2,!!(e.onFrame||e.onAnimate)),{subscribe:u,playAnimation:h,dispatch:i}}const Kt=({url:e})=>{const{sizes:t}=d.useContext(A),n=d.useContext(X),r=Ie(e),{scene:i}=r,s=()=>new Gt().setFromObject(i).getSize(new Z),c=l=>{const u=l||e;return u in t?t[u]:null},a=(l,u)=>{const h=u||e;return h in t||(t[h]=l||s(),n({type:"update",payload:{sizes:{...t}}})),t[h]};return{gltf:r,size:a(),setSize:a,getSize:c}},qn=()=>{const{sizes:e}=d.useContext(A);return{getSizesByUrls:n=>{const r={};return n&&Object.keys(n).forEach(i=>{const s=n[i];s in e?r[i]=e[s]:r[i]=null}),r}}},we=new Map,je=new Map;function Vn(e,t){const n=d.useMemo(()=>{if(je.has(t))return ae.clone(je.get(t));const i=ae.clone(e);return je.set(t,i),ae.clone(i)},[e,t]),r=d.useMemo(()=>{if(we.has(t))return we.get(t);let i=null;return n.traverse(s=>{s instanceof xe&&!i&&(i=s.skeleton)}),i&&we.set(t,i),i},[n,t]);return{clone:n,skeleton:r}}const te={},mt=(e,t)=>e.unstable_is?e.unstable_is(t):t===e,pt=e=>"init"in e,Se=e=>!!e.write,xt=e=>"v"in e||"e"in e,re=e=>{if("e"in e)throw e.e;if((te?"production":void 0)!=="production"&&!("v"in e))throw new Error("[Bug] atom state is not initialized");return e.v},fe=new WeakMap,gt=e=>{var t;return he(e)&&!!((t=fe.get(e))!=null&&t[0])},$n=e=>{const t=fe.get(e);t!=null&&t[0]&&(t[0]=!1,t[1].forEach(n=>n()))},Yt=(e,t)=>{let n=fe.get(e);if(!n){n=[!0,new Set],fe.set(e,n);const r=()=>{n[0]=!1};e.then(r,r)}n[1].add(t)},he=e=>typeof(e==null?void 0:e.then)=="function",qt=(e,t,n)=>{n.p.has(e)||(n.p.add(e),t.then(()=>{n.p.delete(e)},()=>{n.p.delete(e)}))},Ce=(e,t,n)=>{const r=n(e),i="v"in r,s=r.v;if(he(t))for(const c of r.d.keys())qt(e,t,n(c));r.v=t,delete r.e,(!i||!Object.is(s,r.v))&&(++r.n,he(s)&&$n(s))},yt=(e,t,n)=>{var r;const i=new Set;for(const s of((r=n.get(e))==null?void 0:r.t)||[])n.has(s)&&i.add(s);for(const s of t.p)i.add(s);return i},Jn=()=>{const e=new Set,t=()=>{e.forEach(n=>n())};return t.add=n=>(e.add(n),()=>{e.delete(n)}),t},Re=()=>{const e={},t=new WeakMap,n=r=>{var i,s;(i=t.get(e))==null||i.forEach(c=>c(r)),(s=t.get(r))==null||s.forEach(c=>c())};return n.add=(r,i)=>{const s=r||e,c=(t.has(s)?t:t.set(s,new Set)).get(s);return c.add(i),()=>{c==null||c.delete(i),c.size||t.delete(s)}},n},Hn=e=>(e.c||(e.c=Re()),e.m||(e.m=Re()),e.u||(e.u=Re()),e.f||(e.f=Jn()),e),Qn=Symbol(),er=(e=new WeakMap,t=new WeakMap,n=new WeakMap,r=new Set,i=new Set,s=new Set,c={},a=(p,...g)=>p.read(...g),l=(p,...g)=>p.write(...g),u=(p,g)=>{var b;return(b=p.unstable_onInit)==null?void 0:b.call(p,g)},h=(p,g)=>{var b;return(b=p.onMount)==null?void 0:b.call(p,g)},...f)=>{const p=f[0]||(x=>{if((te?"production":void 0)!=="production"&&!x)throw new Error("Atom is undefined or null");let S=e.get(x);return S||(S={d:new Map,p:new Set,n:0},e.set(x,S),u==null||u(x,L)),S}),g=f[1]||(()=>{const x=[],S=v=>{try{v()}catch(w){x.push(w)}};do{c.f&&S(c.f);const v=new Set,w=v.add.bind(v);r.forEach(m=>{var j;return(j=t.get(m))==null?void 0:j.l.forEach(w)}),r.clear(),s.forEach(w),s.clear(),i.forEach(w),i.clear(),v.forEach(S),r.size&&b()}while(r.size||s.size||i.size);if(x.length)throw new AggregateError(x)}),b=f[2]||(()=>{const x=[],S=new WeakSet,v=new WeakSet,w=Array.from(r);for(;w.length;){const m=w[w.length-1],j=p(m);if(v.has(m)){w.pop();continue}if(S.has(m)){if(n.get(m)===j.n)x.push([m,j]);else if((te?"production":void 0)!=="production"&&n.has(m))throw new Error("[Bug] invalidated atom exists");v.add(m),w.pop();continue}S.add(m);for(const E of yt(m,j,t))S.has(E)||w.push(E)}for(let m=x.length-1;m>=0;--m){const[j,E]=x[m];let _=!1;for(const U of E.d.keys())if(U!==j&&r.has(U)){_=!0;break}_&&(y(j),z(j)),n.delete(j)}}),y=f[3]||(x=>{var S;const v=p(x);if(xt(v)&&(t.has(x)&&n.get(x)!==v.n||Array.from(v.d).every(([P,q])=>y(P).n===q)))return v;v.d.clear();let w=!0;const m=()=>{t.has(x)&&(z(x),b(),g())},j=P=>{var q;if(mt(x,P)){const ne=p(P);if(!xt(ne))if(pt(P))Ce(P,P.init,p);else throw new Error("no atom init");return re(ne)}const H=y(P);try{return re(H)}finally{v.d.set(P,H.n),gt(v.v)&&qt(x,v.v,H),(q=t.get(P))==null||q.t.add(x),w||m()}};let E,_;const U={get signal(){return E||(E=new AbortController),E.signal},get setSelf(){return(te?"production":void 0)!=="production"&&!Se(x)&&console.warn("setSelf function cannot be used with read-only atom"),!_&&Se(x)&&(_=(...P)=>{if((te?"production":void 0)!=="production"&&w&&console.warn("setSelf function cannot be called in sync"),!w)try{return D(x,...P)}finally{b(),g()}}),_}},B=v.n;try{const P=a(x,j,U);return Ce(x,P,p),he(P)&&(Yt(P,()=>E==null?void 0:E.abort()),P.then(m,m)),v}catch(P){return delete v.v,v.e=P,++v.n,v}finally{w=!1,B!==v.n&&n.get(x)===B&&(n.set(x,v.n),r.add(x),(S=c.c)==null||S.call(c,x))}}),R=f[4]||(x=>{const S=[x];for(;S.length;){const v=S.pop(),w=p(v);for(const m of yt(v,w,t)){const j=p(m);n.set(m,j.n),S.push(m)}}}),D=f[5]||((x,...S)=>{let v=!0;const w=j=>re(y(j)),m=(j,...E)=>{var _;const U=p(j);try{if(mt(x,j)){if(!pt(j))throw new Error("atom not writable");const B=U.n,P=E[0];Ce(j,P,p),z(j),B!==U.n&&(r.add(j),(_=c.c)==null||_.call(c,j),R(j));return}else return D(j,...E)}finally{v||(b(),g())}};try{return l(x,w,m,...S)}finally{v=!1}}),z=f[6]||(x=>{var S;const v=p(x),w=t.get(x);if(w&&!gt(v.v)){for(const[m,j]of v.d)if(!w.d.has(m)){const E=p(m);N(m).t.add(x),w.d.add(m),j!==E.n&&(r.add(m),(S=c.c)==null||S.call(c,m),R(m))}for(const m of w.d||[])if(!v.d.has(m)){w.d.delete(m);const j=I(m);j==null||j.t.delete(x)}}}),N=f[7]||(x=>{var S;const v=p(x);let w=t.get(x);if(!w){y(x);for(const m of v.d.keys())N(m).t.add(x);if(w={l:new Set,d:new Set(v.d.keys()),t:new Set},t.set(x,w),(S=c.m)==null||S.call(c,x),Se(x)){const m=()=>{let j=!0;const E=(..._)=>{try{return D(x,..._)}finally{j||(b(),g())}};try{const _=h(x,E);_&&(w.u=()=>{j=!0;try{_()}finally{j=!1}})}finally{j=!1}};i.add(m)}}return w}),I=f[8]||(x=>{var S;const v=p(x);let w=t.get(x);if(w&&!w.l.size&&!Array.from(w.t).some(m=>{var j;return(j=t.get(m))==null?void 0:j.d.has(x)})){w.u&&s.add(w.u),w=void 0,t.delete(x),(S=c.u)==null||S.call(c,x);for(const m of v.d.keys()){const j=I(m);j==null||j.t.delete(x)}return}return w}),Y=[e,t,n,r,i,s,c,a,l,u,h,p,g,b,y,R,D,z,N,I],L={get:x=>re(y(x)),set:(x,...S)=>{try{return D(x,...S)}finally{b(),g()}},sub:(x,S)=>{const w=N(x).l;return w.add(S),g(),()=>{w.delete(S),I(x),g()}}};return Object.defineProperty(L,Qn,{value:Y}),L},Vt=er,tr=Hn,vt=Yt,Ge={};let nr=0;function O(e,t){const n=`atom${++nr}`,r={toString(){return(Ge?"production":void 0)!=="production"&&this.debugLabel?n+":"+this.debugLabel:n}};return typeof e=="function"?r.read=e:(r.init=e,r.read=rr,r.write=or),t&&(r.write=t),r}function rr(e){return e(this)}function or(e,t,n){return t(this,typeof n=="function"?n(e(this)):n)}const ir=()=>{let e=0;const t=tr({}),n=new WeakMap,r=new WeakMap,i=Vt(n,r,void 0,void 0,void 0,void 0,t,void 0,(a,l,u,...h)=>e?u(a,...h):a.write(l,u,...h)),s=new Set;return t.m.add(void 0,a=>{s.add(a);const l=n.get(a);l.m=r.get(a)}),t.u.add(void 0,a=>{s.delete(a);const l=n.get(a);delete l.m}),Object.assign(i,{dev4_get_internal_weak_map:()=>(console.log("Deprecated: Use devstore from the devtools library"),n),dev4_get_mounted_atoms:()=>s,dev4_restore_atoms:a=>{const l={read:()=>null,write:(u,h)=>{++e;try{for(const[f,p]of a)"init"in f&&h(f,p)}finally{--e}}};i.set(l)}})};function $t(){return(Ge?"production":void 0)!=="production"?ir():Vt()}let Q;function sr(){return Q||(Q=$t(),(Ge?"production":void 0)!=="production"&&(globalThis.__JOTAI_DEFAULT_STORE__||(globalThis.__JOTAI_DEFAULT_STORE__=Q),globalThis.__JOTAI_DEFAULT_STORE__!==Q&&console.warn("Detected multiple Jotai instances. It may cause unexpected behavior with the default store. https://github.com/pmndrs/jotai/discussions/2044"))),Q}const ar={},Jt=d.createContext(void 0);function Xe(e){return d.useContext(Jt)||sr()}function cr({children:e,store:t}){const n=d.useRef(void 0);return!t&&!n.current&&(n.current=$t()),d.createElement(Jt.Provider,{value:t||n.current},e)}const Me=e=>typeof(e==null?void 0:e.then)=="function",De=e=>{e.status||(e.status="pending",e.then(t=>{e.status="fulfilled",e.value=t},t=>{e.status="rejected",e.reason=t}))},lr=F.use||(e=>{if(e.status==="pending")throw e;if(e.status==="fulfilled")return e.value;throw e.status==="rejected"?e.reason:(De(e),e)}),ke=new WeakMap,bt=(e,t)=>{let n=ke.get(e);return n||(n=new Promise((r,i)=>{let s=e;const c=u=>h=>{s===u&&r(h)},a=u=>h=>{s===u&&i(h)},l=()=>{try{const u=t();Me(u)?(ke.set(u,n),s=u,u.then(c(u),a(u)),vt(u,l)):r(u)}catch(u){i(u)}};e.then(c(e),a(e)),vt(e,l)}),ke.set(e,n)),n};function Be(e,t){const{delay:n,unstable_promiseStatus:r=!F.use}={},i=Xe(),[[s,c,a],l]=d.useReducer(h=>{const f=i.get(e);return Object.is(h[0],f)&&h[1]===i&&h[2]===e?h:[f,i,e]},void 0,()=>[i.get(e),i,e]);let u=s;if((c!==i||a!==e)&&(l(),u=i.get(e)),d.useEffect(()=>{const h=i.sub(e,()=>{if(r)try{const f=i.get(e);Me(f)&&De(bt(f,()=>i.get(e)))}catch{}if(typeof n=="number"){setTimeout(l,n);return}l()});return l(),h},[i,e,n,r]),d.useDebugValue(u),Me(u)){const h=bt(u,()=>i.get(e));return r&&De(h),lr(h)}return u}function ur(e,t){const n=Xe();return d.useCallback((...i)=>{if((ar?"production":void 0)!=="production"&&!("write"in e))throw new Error("not writable atom");return n.set(e,...i)},[n,e])}function dr(e,t){return[Be(e),ur(e)]}const fr={position:{x:0,y:0,z:0},euler:{x:0,y:0,z:0},quaternion:{x:0,y:0,z:0,w:1}},hr={type:"character",controller:"keyboard",camera:"normal",scrollBlock:!1},mr={characterUrl:null,vehicleUrl:null,wheelUrl:null,airplaneUrl:null,ridingUrl:null},pr={enableRiding:!1,isRiderOn:!1,rideableId:null},xr={visible:!1,size:200,position:{x:10,y:10}},gr={},yr={},vr={character:{current:"idle",animationNames:[],keyControl:{},store:{},default:"idle"},vehicle:{current:"idle",animationNames:[],keyControl:{},store:{},default:"idle"},airplane:{current:"idle",animationNames:[],keyControl:{},store:{},default:"idle"}},br={offset:{x:-10,y:-10,z:-10},zoom:1,maxDistance:-7},wr={enabled:!1},jr={clicked:!1,position:{x:0,y:0}},Sr={},Cr={control:!1},We=O(fr),Ze=O(hr),Ke=O(mr),Ye=O(pr),qe=O(xr),Ve=O(gr),$e=O(yr),Je=O(vr),He=O(br),Qe=O(wr),et=O(jr),tt=O({}),nt=O(Sr),rt=O(Cr),Ht=O(e=>({activeState:e(We),mode:e(Ze),urls:e(Ke),states:e(Ye),minimap:e(qe),control:e(Ve),refs:e($e),animationState:e(Je),cameraOption:e(He),clickerOption:e(Qe),clicker:e(et),rideable:e(tt),sizes:e(nt),block:e(rt)})),Rr=O(null,(e,t,n)=>{switch(e(Ht),n.type){case"SET_ACTIVE_STATE":t(We,n.payload);break;case"SET_MODE":t(Ze,n.payload);break;case"SET_URLS":t(Ke,n.payload);break;case"SET_STATES":t(Ye,n.payload);break;case"SET_MINIMAP":t(qe,n.payload);break;case"SET_CONTROL":t(Ve,n.payload);break;case"SET_REFS":t($e,n.payload);break;case"SET_ANIMATION_STATE":t(Je,n.payload);break;case"SET_CAMERA_OPTION":t(He,n.payload);break;case"SET_CLICKER_OPTION":t(Qe,n.payload);break;case"SET_CLICKER":t(et,n.payload);break;case"SET_RIDEABLE":t(tt,n.payload);break;case"SET_SIZES":t(nt,n.payload);break;case"SET_BLOCK":t(rt,n.payload);break}});function kr(){return Be(Ht)}function Pr(){const[,e]=dr(Rr);return e}function Qt(){return kr()}function Or(){return Pr()}const J={airplane:{angleDelta:k(Math.PI/256,Math.PI/256,Math.PI/256),maxAngle:k(Math.PI/8,Math.PI/8,Math.PI/8),maxSpeed:60,accelRatio:2,brakeRatio:5,buoyancy:.2,linearDamping:1},vehicle:{maxSpeed:60,accelRatio:2,brakeRatio:5,wheelOffset:.1,linearDamping:.5},character:{walkSpeed:10,runSpeed:20,turnSpeed:10,jumpSpeed:1,linearDamping:1},callbacks:{onReady:()=>{},onFrame:()=>{},onDestory:()=>{},onAnimate:()=>{}},refs:{colliderRef:null,rigidBodyRef:null,outerGroupRef:null,innerGroupRef:null,characterInnerRef:null},controllerOptions:{lerp:{cameraTurn:1,cameraPosition:1}}},Ae=O(J.airplane),Ee=O(J.vehicle),_e=O(J.character),Ne=O(J.callbacks),ze=O(J.refs),Te=O(J.controllerOptions),Mr=O(e=>({airplane:e(Ae),vehicle:e(Ee),character:e(_e),callbacks:e(Ne),refs:e(ze),controllerOptions:e(Te)}));O(null,(e,t,n)=>{switch(n.type){case"SET_AIRPLANE":t(Ae,n.payload);break;case"SET_VEHICLE":t(Ee,n.payload);break;case"SET_CHARACTER":t(_e,n.payload);break;case"SET_CALLBACKS":t(Ne,n.payload);break;case"SET_REFS":t(ze,n.payload);break;case"SET_CONTROLLER_OPTIONS":t(Te,n.payload);break;case"UPDATE_AIRPLANE":t(Ae,r=>({...r,...n.payload}));break;case"UPDATE_VEHICLE":t(Ee,r=>({...r,...n.payload}));break;case"UPDATE_CHARACTER":t(_e,r=>({...r,...n.payload}));break;case"UPDATE_CALLBACKS":t(Ne,r=>({...r,...n.payload}));break;case"UPDATE_REFS":t(ze,r=>({...r,...n.payload}));break;case"UPDATE_CONTROLLER_OPTIONS":t(Te,r=>({...r,...n.payload}));break}});function Dr(){return Be(Mr)}function en(){return Dr()}function Ar(e){const{rigidBodyRef:t,controllerContext:{airplane:n}}=e,{linearDamping:r}=n;t.current.setLinearDamping(r)}function Er(e){const{innerGroupRef:t,worldContext:{activeState:n,control:r},controllerContext:{airplane:i},matchSizes:s}=e,{forward:c,backward:a,leftward:l,rightward:u,shift:h,space:f}=r,{angleDelta:p,maxAngle:g,accelRatio:b}=i;if(!s||!s.airplaneUrl)return null;let y=0;y=f?Number(h):Number(h)*b;const R=Number(a)-Number(c),D=Number(u)-Number(l),z=k().set(y,y,y);n.euler.y+=-D*p.y;const N=g.x*R,I=g.z*D,Y=t.current.rotation.x,L=t.current.rotation.z,x=g.x,S=g.z,v=t.current.clone();Y<-x?v.rotation.x=-x+N:Y>x?v.rotation.x=x+N:v.rotateX(N),L<-S?v.rotation.z=-S+I:L>S?v.rotation.z=S+I:v.rotateZ(I),n.euler.x=v.rotation.x,n.euler.z=v.rotation.z,v.rotation.y=0,t.current.setRotationFromQuaternion(G().setFromEuler(t.current.rotation.clone()).slerp(G().setFromEuler(v.rotation.clone()),.2)),n.rotation=v.rotation,n.direction=z.multiply(k(Math.sin(n.euler.y),-R,Math.cos(n.euler.y))),n.dir=n.direction.normalize()}function _r(e){const{rigidBodyRef:t,worldContext:{activeState:n}}=e;t.current.setGravityScale(n.position.y<10?(1-.1)/-10*n.position.y+1:.1,!1)}function Nr(e){const{rigidBodyRef:t,worldContext:{activeState:n},controllerContext:{airplane:r}}=e,{maxSpeed:i}=r,s=t.current.linvel();if(C(s).length()<i){const a=t.current.mass();t.current.applyImpulse(C({x:n.direction.x,y:n.direction.y,z:n.direction.z}).multiplyScalar(a),!1)}}function zr(e){const{rigidBodyRef:t,worldContext:{activeState:n},dispatch:r}=e;n.position=C(t.current.translation()),n.velocity=C(t.current.linvel());const i=n.euler.clone();i.x=0,i.z=0,t.current.setRotation(G().setFromEuler(i),!0),r({type:"update",payload:{activeState:{...n}}})}function Tr(e){const{worldContext:{states:t,rideable:n,mode:r},dispatch:i}=e,{isRiding:s}=t;s&&(n.objectType=null,n.key=null,r.type="character",t.isRiding=!1,t.enableRiding=!1),i({type:"update",payload:{mode:{...r},rideable:{...n}}})}function Ir(e){Er(e),Nr(e),Ar(e),_r(e),Tr(e),zr(e)}function Fr({activeState:e,control:t,mode:n,clicker:r}){const{forward:i,backward:s,leftward:c,rightward:a}=t,l=Number(c)-Number(a),u=Number(i)-Number(s);let h=0;if(r.isOn)e.euler.y=Math.PI/2-r.angle,h=1;else{if(l===0&&u===0)return;e.euler.y+=l*Math.PI/32,h=u}const f=k(h,0,h);e.direction=f.multiply(k(-Math.sin(e.euler.y),0,-Math.cos(e.euler.y))),e.dir=e.direction.normalize()}function wt({activeState:e,control:t,mode:n,clicker:r}){const{forward:i,backward:s,leftward:c,rightward:a}=t;if(r.isOn)e.euler.y=Math.PI/2-r.angle,e.dir.set(-Math.sin(e.euler.y),0,-Math.cos(e.euler.y));else{const l=Number(c)-Number(a),u=Number(i)-Number(s);if(l===0&&u===0)return;const h=k(l,0,u),f=On(h);e.euler.y=f,e.dir.set(l,0,u)}}function Lr(e){const{worldContext:t}=e,n=t.mode.control;n==="thirdPerson"||n==="normal"||n==="firstPerson"||n==="topDown"||n==="sideScroll"?wt(t):n==="thirdPersonOrbit"||n==="orbit"?Fr(t):wt(t)}function Ur(e){const{rigidBodyRef:t,worldContext:{states:n,activeState:r}}=e,{isMoving:i,isRunning:s}=n,{controllerContext:{character:{walkSpeed:c,runSpeed:a,jumpSpeed:l}}}=e,{isOnTheGround:u,isJumping:h}=n,f=C();if(h&&u&&f.setY(l*t.current.mass()),i){const p=s?a:c,g=C().addScalar(p).multiply(r.dir.clone().normalize().negate()),b=t.current.mass(),R=g.clone().sub(r.velocity).multiplyScalar(b);f.setX(R.x),f.setZ(R.z)}t.current.applyImpulse(f,!0),r.position=C(t.current.translation()),r.velocity=C(t.current.linvel())}function Gr(e){const{rigidBodyRef:t,innerGroupRef:n,controllerContext:{character:{linearDamping:r}},worldContext:{activeState:i,states:s,block:c},delta:a}=e;s.isJumping||t.current.linvel().y<0?t.current.setLinearDamping(r):t.current.setLinearDamping(s.isNotMoving?r*5:r),t.current.setEnabledRotations(!1,!1,!1,!1);const l=G().setFromEuler(i.euler);n.current.quaternion.angleTo(l)>.01&&n.current.quaternion.rotateTowards(l,6*a)}function Xr(e){var h;const{rigidBodyRef:t,state:n,worldContext:{clicker:r,mode:i,clickerOption:s,block:c},dispatch:a}=e,l=C((h=t.current)==null?void 0:h.translation());let u=ft(l,r.point,!1);if(s.autoStart&&s.queue[0]instanceof Z){const f=C(s.queue[0]),p=Math.atan2(f.z-l.z,f.x-l.x);a({type:"update",payload:{clicker:{...r,isOn:!0,angle:p}}}),u=ft(l,s.queue[0],!1)}if(u<1&&r.isOn)if(s.track&&s.queue.length!==0){const f=s.queue.shift();if(f instanceof Z){const p=C(f),g=Math.atan2(p.z-l.z,p.x-l.x);a({type:"update",payload:{clicker:{...r,point:f,angle:g}}})}else{const{action:p,beforeCB:g,afterCB:b,time:y}=f;p==="stop"&&(n.clock.stop(),g(n),console.log(),setTimeout(()=>{n.clock.start(),b(n)},y))}s.loop&&s.queue.push(f)}else a({type:"update",payload:{clicker:{...r,isOn:!1,isRun:!1}}})}function Br(e){const{worldContext:{control:t,clicker:n,mode:r},dispatch:i}=e,{keyS:s}=t;s&&n.isOn&&i({type:"update",payload:{clicker:{...n,isOn:!1,isRun:!1}}})}function jt(e){Lr(e),Ur(e),Gr(e),Br(e),Xr(e)}function Wr(e){const{colliderRef:t,groundRay:n,worldContext:{states:r,activeState:i}}=e;if(n.origin.addVectors(i.position,C(n.offset)),(!n.hit||!n.rayCast||!t.current)&&(r.isOnTheGround=!1),n.hit){const s=n.length*2,c=n.length*.8;n.hit.toi>=s?(r.isFalling=!0,r.isOnTheGround=!1):c<=n.hit.toi&&n.hit.toi<s?r.isFalling=!0:n.hit.toi<c&&(r.isFalling=!1,r.isOnTheGround=!0)}}function Zr(e){const{worldContext:{states:t,mode:n,control:r,clicker:i,clickerOption:s}}=e,{shift:c,space:a,forward:l,backward:u,leftward:h,rightward:f}=r;t.isJumping=a;const p=l||u||h||f,g=i.isOn;t.isMoving=p||g,t.isNotMoving=!t.isMoving,t.isRunning=c&&p||i.isRun&&g&&s.isRun}function Kr(e){const{worldContext:{states:t,control:n}}=e;Object.keys(n).forEach(r=>{t.isPush[r]=n[r]})}function Yr(e){const{worldContext:{states:t}}=e,{isRiderOn:n}=t;n&&t.isPush.keyR&&(t.isRiding=!0)}function qr(e){const{outerGroupRef:t,worldContext:{states:n,activeState:r}}=e;n.isMoving&&t&&t.current&&(n.isRotated=Math.sin(t.current.rotation.y).toFixed(3)===Math.sin(r.euler.y).toFixed(3))}function Vr(e){Wr(e),Zr(e),qr(e),Kr(e),Yr(e)}function $r(e){const{rigidBodyRef:t,worldContext:{control:n},controllerContext:{vehicle:r}}=e,{space:i}=n,{brakeRatio:s,linearDamping:c}=r;t.current.setLinearDamping(i?s:c)}function Jr(e){const{worldContext:{activeState:t,control:n}}=e,{forward:r,backward:i,leftward:s,rightward:c}=n,a=Number(s)-Number(c),l=Number(r)-Number(i),u=C().set(l,0,l);return t.euler.y+=a*(Math.PI/64),u}function Hr(e){const{worldContext:{mode:t,activeState:n}}=e,r=C();r.copy(Jr(e)),n.direction=r.multiply(k(Math.sin(n.euler.y),0,Math.cos(n.euler.y))),n.dir=n.direction.normalize()}function Qr(e){const{rigidBodyRef:t,worldContext:{activeState:n,control:r},controllerContext:{vehicle:i}}=e,{shift:s}=r,{maxSpeed:c,accelRatio:a}=i,l=t.current.linvel();if(C(l).length()<c){const h=t.current.mass();let f=s?a:1;t.current.applyImpulse(C().addScalar(f).multiply(n.dir.clone().normalize()).multiplyScalar(h),!1)}}function eo(e){const{rigidBodyRef:t,worldContext:{activeState:n}}=e;n.position=C(t.current.translation()),n.velocity=C(t.current.linvel()),t.current.setRotation(G().setFromEuler(n.euler.clone()),!1)}function to(e){const{worldContext:{states:t,rideable:n,mode:r},dispatch:i}=e,{isRiding:s}=t;s&&(n.objectType=null,n.key=null,r.type="character",t.isRiding=!1,t.enableRiding=!1),i({type:"update",payload:{mode:{...r},rideable:{...n}}})}function no(e){Hr(e),Qr(e),$r(e),to(e),eo(e)}function ro({groundRay:e,rigidBodyRef:t,outerGroupRef:n,innerGroupRef:r,colliderRef:i}){var y;const s=Qt(),c=en(),a=Or(),{mode:l,activeState:u,block:h}=s,{getSizesByUrls:f}=qn();d.useEffect(()=>{!t||!r||t.current&&r.current&&(t.current.lockRotations(!1,!0),u.euler.set(0,0,0),t.current.setTranslation(u.position.clone().add(k(0,5,0)),!0))},[l.type,t,r,u]),d.useEffect(()=>{t!=null&&t.current&&h.control&&(t.current.resetForces(!1),t.current.resetTorques(!1))},[h.control]);const p=d.useMemo(()=>(t==null?void 0:t.current)&&(n==null?void 0:n.current)&&(r==null?void 0:r.current),[t==null?void 0:t.current,n==null?void 0:n.current,r==null?void 0:r.current]),g=d.useMemo(()=>f(s==null?void 0:s.urls),[f,s==null?void 0:s.urls]),b=d.useMemo(()=>{switch(l.type){case"vehicle":return no;case"character":return jt;case"airplane":return Ir;default:return jt}},[l.type]);ge(`physics-${((y=t==null?void 0:t.current)==null?void 0:y.handle)||"unknown"}`,(R,D)=>{if(!p||h.control)return;const z={rigidBodyRef:t,outerGroupRef:n,innerGroupRef:r,colliderRef:i,groundRay:e,state:R,delta:D,worldContext:s,controllerContext:c,dispatch:a,matchSizes:g};b(z),Vr(z)},0,p&&!h.control)}function oo({url:e,children:t,offset:n,currentAnimation:r}){const{gltf:i}=Kt({url:e}),{animations:s,scene:c}=i,{actions:a,ref:l}=Fe(s),u=d.useMemo(()=>ae.clone(c),[c]),{nodes:h}=Tt(u),f=Object.values(h).find(p=>p.type==="Object3D");return Ue({type:"character",currentAnimation:r||"ride",actions:a,animationRef:l,isActive:!1}),o.jsx(o.Fragment,{children:o.jsxs("group",{position:n,children:[f&&o.jsx("primitive",{object:f,visible:!1,receiveShadow:!0,castShadow:!0,ref:l}),Object.keys(h).map((p,g)=>{const b=h[p];if(b instanceof xe)return o.jsx("skinnedMesh",{castShadow:!0,receiveShadow:!0,material:b.material,geometry:b.geometry,skeleton:b.skeleton},g);if(b instanceof Xt)return o.jsx("mesh",{castShadow:!0,receiveShadow:!0,material:b.material,geometry:b.geometry},g)}),t]})})}const io=d.forwardRef((e,t)=>o.jsxs("group",{receiveShadow:!0,castShadow:!0,ref:t,userData:{intangible:!0},children:[e.isRiderOn&&e.enableRiding&&e.isActive&&e.ridingUrl&&o.jsx(oo,{url:e.ridingUrl,offset:e.offset}),e.children,e.objectNode&&e.animationRef&&o.jsx("primitive",{object:e.objectNode,visible:!1,receiveShadow:!0,castShadow:!0,ref:e.animationRef}),Object.keys(e.nodes).map((n,r)=>{const i=e.nodes[n];if(i instanceof xe)return o.jsx("skinnedMesh",{castShadow:!0,receiveShadow:!0,material:i.material,geometry:i.geometry,skeleton:i.skeleton},r);if(i instanceof Xt)return o.jsx("mesh",{castShadow:!0,receiveShadow:!0,material:i.material,geometry:i.geometry},r)})]})),so=({url:e,isActive:t,componentType:n,currentAnimation:r,color:i,skeleton:s})=>{const{scene:c,animations:a}=Ie(e),{actions:l,ref:u}=Fe(a),h=d.useMemo(()=>{const f=[];return c.traverse(p=>{if(p instanceof xe){const g=p.clone();g.skeleton=s,g.bind(s,g.bindMatrix),f.push(g)}}),f},[c,s]);return Ue({type:n,actions:l,animationRef:u,currentAnimation:t?void 0:r,isActive:t}),o.jsx(o.Fragment,{children:h.map((f,p)=>o.jsx("skinnedMesh",{castShadow:!0,receiveShadow:!0,geometry:f.geometry,skeleton:s,material:f.name==="color"&&i?new yn({color:i}):f.material},p))})};function ao(){const e=It();return d.useCallback(({ray:n,ref:r})=>e.world.castRay(n.rayCast,n.length,!0,void 0,void 0,r.current,void 0),[e])}function co(){const{rapier:e}=It(),t=ao();return({groundRay:r,length:i,colliderRef:s})=>{var c;r.length=i,r.rayCast=new e.Ray(r.origin,r.dir),r.hit=t({ray:r,ref:s}),r.parent=(c=r.hit)==null?void 0:c.collider.parent()}}const ot=d.forwardRef((e,t)=>{var g;const{size:n}=Kt({url:e.url}),r=co();d.useEffect(()=>{e.groundRay&&e.colliderRef&&r({groundRay:e.groundRay,length:.5,colliderRef:e.colliderRef})},[e.groundRay,e.colliderRef,r]);const{scene:i,animations:s}=Ie(e.url),{actions:c,ref:a}=Fe(s),l=Qt();en();const{clone:u,skeleton:h}=Vn(i,e.url);if(e.isActive){Mn({type:e.componentType,groundRay:e.groundRay});const b={state:null,worldContext:l,controllerOptions:e.controllerOptions};Kn(b),ro({outerGroupRef:e.outerGroupRef,innerGroupRef:e.innerGroupRef,rigidBodyRef:t,colliderRef:e.colliderRef,groundRay:e.groundRay})}Ue({type:e.componentType,actions:c,animationRef:a,currentAnimation:e.isActive?void 0:e.currentAnimation,isActive:e.isActive}),Yn({props:e,actions:c,componentType:e.componentType});const{nodes:f}=Tt(u),p=Object.values(f).find(b=>b.type==="Object3D");return o.jsxs(Ft,{colliders:!1,ref:t,name:e.name,rotation:K().set(0,((g=e.rotation)==null?void 0:g.clone().y)||0,0).clone(),userData:e.userData,type:e.rigidbodyType||(e.isActive?"dynamic":"fixed"),sensor:e.sensor,onIntersectionEnter:e.onIntersectionEnter,onCollisionEnter:e.onCollisionEnter,...e.rigidBodyProps,children:[!e.isNotColliding&&o.jsx(xn,{ref:e.colliderRef,args:[(n.y/2-n.x)*1.2,n.x*1.2],position:[0,(n.y/2+n.x/2)*1.2,0]}),o.jsxs(io,{objectNode:p,animationRef:a,nodes:f,ref:e.innerGroupRef,isActive:e.isActive,isRiderOn:e.isRiderOn,enableRiding:e.enableRiding,ridingUrl:e.ridingUrl,offset:e.offset,parts:e.parts,children:[e.children,e.parts&&e.parts.length>0&&e.parts.map(({url:b,color:y},R)=>b?o.jsx(so,{url:b,isActive:e.isActive,componentType:e.componentType,currentAnimation:e.currentAnimation,color:y,skeleton:h},R+b):null)]})]})});function tn(e){const{rigidBodyRef:t,outerGroupRef:n}=e;return o.jsx(Le,{ref:n,children:o.jsx(ot,{ref:t,name:e.name,componentType:"airplane",ridingUrl:e.ridingUrl,...e,children:e.children})})}function lo(e){return o.jsx(tn,{name:"airplane",isActive:!0,currentAnimation:"idle",componentType:"airplane",ridingUrl:e.ridingUrl,...e,children:e.children})}function nn(e){const{outerGroupRef:t}=e;return o.jsx(Le,{ref:t,children:o.jsx(ot,{name:"character",url:e.url,controllerOptions:e.controllerOptions,ref:e.rigidBodyRef,groundRay:e.groundRay,isNotColliding:e.isNotColliding,...e,children:e.children})})}function uo({children:e,props:t,refs:n,urls:r}){return o.jsx(nn,{url:r.characterUrl,isActive:!0,componentType:"character",rigidbodyType:"dynamic",controllerOptions:t.controllerOptions,groundRay:t.groundRay,onAnimate:t.onAnimate,onFrame:t.onFrame,onReady:t.onReady,onDestory:t.onDestory,rigidBodyProps:t.rigidBodyProps,parts:t.parts,...n,children:e})}function rn(e){const{rigidBodyRef:t,outerGroupRef:n}=e;return o.jsx(Le,{ref:n,children:o.jsx(ot,{ref:t,name:e.name,componentType:"vehicle",ridingUrl:e.ridingUrl,...e,children:e.children})})}function fo(e){return o.jsx(rn,{name:"vehicle",isActive:!0,currentAnimation:"idle",componentType:"vehicle",ridingUrl:e.ridingUrl,...e,children:e.children})}function ho({props:e,refs:t}){const{mode:n,states:r,rideable:i,urls:s}=d.useContext(A),{enableRiding:c,isRiderOn:a,rideableId:l}=r,u=d.useMemo(()=>l&&i[l]?i[l].offset:C(),[l,i]),h=d.useMemo(()=>({controllerOptions:e.controllerOptions,enableRiding:c,isRiderOn:a,groundRay:e.groundRay,offset:u,...t,children:e.children}),[e.controllerOptions,c,a,e.groundRay,u,t,e.children]);switch(n.type){case"character":return o.jsx(uo,{props:e,refs:t,urls:s,children:e.children});case"vehicle":return o.jsx(fo,{...h,url:s.vehicleUrl,wheelUrl:s.wheelUrl,ridingUrl:s.ridingUrl});case"airplane":return o.jsx(lo,{...h,url:s.airplaneUrl,ridingUrl:s.ridingUrl});default:return null}}function it(){const e=d.useRef(null),t=d.useRef(null),n=d.useRef(null),r=d.useRef(null);return{rigidBodyRef:e,outerGroupRef:t,innerGroupRef:n,colliderRef:r}}function mo(e){const{rigidBodyRef:t,outerGroupRef:n,innerGroupRef:r,colliderRef:i}=it(),s=d.useMemo(()=>e.position.y<10?(1-.1)/-10*e.position.y+1:.1,[e.position.y]),c=d.useMemo(()=>{const l=e.rotation.clone();return l.y=0,l},[e.rotation]);ge(`passive-airplane-${e.name||"unnamed"}`,()=>{r.current&&r.current.setRotationFromQuaternion(G().setFromEuler(r.current.rotation.clone()).slerp(G().setFromEuler(c),.2)),t.current&&t.current.setGravityScale(s,!1)},3,!!(r.current||t.current));const a={rigidBodyRef:t,outerGroupRef:n,innerGroupRef:r,colliderRef:i};return o.jsx(tn,{isActive:!1,componentType:"airplane",name:"airplane",...e,...a,children:e.children})}function po(e){const t=it();return d.useEffect(()=>{t.rigidBodyRef&&t.rigidBodyRef.current&&t.rigidBodyRef.current.setEnabledRotations(!1,!1,!1,!1)},[t.rigidBodyRef]),o.jsx(nn,{isActive:!1,componentType:"character",controllerOptions:e.controllerOptions||{lerp:{cameraTurn:1,cameraPosition:1}},position:e.position,rotation:e.rotation,groundRay:e.groundRay,currentAnimation:e.currentAnimation,...t,...e,children:e.children})}function xo(e){const{rigidBodyRef:t,outerGroupRef:n,innerGroupRef:r,colliderRef:i}=it(),s={rigidBodyRef:t,outerGroupRef:n,innerGroupRef:r,colliderRef:i};return o.jsx(rn,{isActive:!1,componentType:"vehicle",name:"vehicle",...e,...s,children:e.children})}const St={KeyW:"forward",KeyA:"leftward",KeyS:"backward",KeyD:"rightward",ArrowUp:"forward",ArrowDown:"backward",ArrowLeft:"leftward",ArrowRight:"rightward",Space:"space",ShiftLeft:"shift",ShiftRight:"shift",KeyZ:"keyZ",KeyR:"keyR",KeyF:"keyF",KeyE:"keyE",Escape:"escape"};function go(){const{control:e,mode:t}=d.useContext(A),n=d.useContext(X),r=d.useRef(new Set);return d.useEffect(()=>{const i=a=>{const l=St[a.code];if(l&&!r.current.has(a.code)){r.current.add(a.code),a.code==="Space"&&a.preventDefault();const u={...e,[l]:!0};n({type:"update",payload:{control:u}})}},s=a=>{const l=St[a.code];if(l&&r.current.has(a.code)){r.current.delete(a.code);const u={...e,[l]:!1};n({type:"update",payload:{control:u}})}},c=()=>{if(document.hidden){r.current.clear();const a=Object.keys(e).reduce((l,u)=>(l[u]=!1,l),{});n({type:"update",payload:{control:a}})}};return window.addEventListener("keydown",i),window.addEventListener("keyup",s),document.addEventListener("visibilitychange",c),()=>{window.removeEventListener("keydown",i),window.removeEventListener("keyup",s),document.removeEventListener("visibilitychange",c)}},[e,n,t.controller]),{pressedKeys:Array.from(r.current)}}const $={airplane:{angleDelta:k(Math.PI/256,Math.PI/256,Math.PI/256),maxAngle:k(Math.PI/8,Math.PI/8,Math.PI/8),maxSpeed:60,accelRatio:2,brakeRatio:5,buoyancy:.2,linearDamping:1},vehicle:{maxSpeed:60,accelRatio:2,brakeRatio:5,wheelOffset:.1,linearDamping:.5},character:{walkSpeed:10,runSpeed:20,turnSpeed:10,jumpSpeed:1,linearDamping:1},callbacks:{onReady:()=>{},onFrame:()=>{},onDestory:()=>{},onAnimate:()=>{}},refs:{colliderRef:null,rigidBodyRef:null,outerGroupRef:null,innerGroupRef:null,characterInnerRef:null},controllerOptions:{lerp:{cameraTurn:1,cameraPosition:1}}},Ct=d.createContext({...$}),yo=d.createContext(null);function vo(e,t){switch(t.type){case"init":return{...e};case"update":return{...e,...t.payload}}}const bo=(e,t)=>{t({type:"update",payload:e})};function wo(e){const t=d.useContext(A),n=d.useContext(X),r=d.useMemo(()=>t!=null&&t.control?t.mode.controller==="clicker"?t.mode.isButton?{...t.control}:{}:{...t.control}:null,[t==null?void 0:t.mode.controller,t==null?void 0:t.mode.isButton,t==null?void 0:t.control]);d.useEffect(()=>{r&&n({type:"update",payload:{control:r}})},[r,n]);const i=d.useMemo(()=>({origin:C(),dir:C({x:0,y:-1,z:0}),offset:C({x:0,y:-1,z:0}),hit:null,parent:null,rayCast:null,length:10}),[]),s=d.useMemo(()=>({origin:C(),hit:new ct,rayCast:new ct(C(),C(),0,-7),dir:C(),position:C(),length:-t.cameraOption.maxDistance,detected:[],intersects:[],intersectObjectMap:{}}),[t.cameraOption.maxDistance]),c=d.useCallback(a=>{bo({refs:{...a}},n)},[n]);return d.useEffect(()=>{e.refs&&c(e.refs)},[e.refs,c]),{groundRay:i,cameraRay:s}}function jo(e){return o.jsx(So,{...e,children:e.children})}function So(e){An(),go();const t=d.useRef(null),n=d.useRef(null),r=d.useRef(null),i=d.useRef(null),s=d.useRef(null),c=d.useRef(null),[a,l]=d.useReducer(vo,{airplane:{...$.airplane,...e.airplane},vehicle:{...$.vehicle,...e.vehicle},character:{...$.character,...e.character},callbacks:{...$.callbacks,onReady:e.onReady,onFrame:e.onFrame,onDestory:e.onDestory,onAnimate:e.onAnimate},refs:{colliderRef:t,rigidBodyRef:n,outerGroupRef:r,innerGroupRef:i,characterInnerRef:s},controllerOptions:{...$.controllerOptions,...e.controllerOptions}}),u=d.useMemo(()=>({value:a,dispatch:l}),[a]),h=d.useMemo(()=>({colliderRef:t,rigidBodyRef:n,outerGroupRef:r,innerGroupRef:i,characterInnerRef:s,passiveRigidBodyRef:c}),[t,n,r,i,s,c]),f={...wo({refs:h}),children:e.children,groupProps:e.groupProps,rigidBodyProps:e.rigidBodyProps,controllerOptions:u.value.controllerOptions,parts:e.parts,...u.value.callbacks,...h},p=ln(A,Ct);return o.jsx(p,{children:o.jsx(Ct.Provider,{value:u.value,children:o.jsx(yo.Provider,{value:u.dispatch,children:o.jsx(ho,{props:f,refs:h})})})})}function Co(){const{activeState:e,mode:t,clicker:n}=d.useContext(A),r=d.useContext(X);return{moveClicker:(s,c,a)=>{if(a!=="ground")return;const l=e.position,u=k(s.point.x,s.point.y,s.point.z),h=Math.atan2(u.z-l.z,u.x-l.x);r({type:"update",payload:{clicker:{...n,point:k(u.x,0,u.z),angle:h,isOn:!0,isRun:c}}})}}}function Ro({type:e="normal",text:t,position:n,children:r}){const i=d.useRef(null),{minimap:s}=d.useContext(A),c=d.useContext(X),{moveClicker:a}=Co();return d.useEffect(()=>{if(i.current){const l=new Gt().setFromObject(i.current),u=C(l.getSize(new Z)).clone(),h=C(l.getCenter(new Z)).clone(),f={type:e||"normal",text:t,size:u,center:h};s.props[t]=f,c({type:"update",payload:{minimap:{...s}}})}},[]),o.jsx("group",{ref:i,position:n,onPointerDown:l=>{l.srcElement instanceof HTMLDivElement||a(l,!1,e)},children:r})}function ko({onMarker:e,runMarker:t}){const{clicker:n,mode:r,clickerOption:i}=d.useContext(A),s=[];for(let c=0;c<i.queue.length;c++)i.queue[c]instanceof Z&&s.push(i.queue[c]);return o.jsxs(o.Fragment,{children:[o.jsxs("group",{position:n.point,children:[n.isOn&&e,n.isOn&&i.isRun&&n.isRun&&t]}),i.line&&s.map((c,a)=>{if(c instanceof Z){const l=a,u=a===0?s.length-1:a-1;return o.jsxs("group",{position:[0,1,0],children:[o.jsx(un,{worldUnits:!0,points:[s[u],s[l]],color:"turquoise",transparent:!0,opacity:.5,lineWidth:.4}),o.jsxs("mesh",{position:c,children:[o.jsx("sphereGeometry",{args:[.6,30,.6]}),o.jsx("meshStandardMaterial",{color:"turquoise",transparent:!0,opacity:.8})]},a)]},a)}})]})}function Po(){const{control:e}=d.useContext(A),t=d.useContext(X);return{pushKey:(r,i)=>{e[r]=i,t({type:"update",payload:{control:{...e}}})}}}var Oo="_14e7l20",Mo="_14e7l21 _14ssv4f1 _14ssv4f0",Do="_14e7l22";function Ao({value:e,name:t,gamePadButtonStyle:n}){const[r,i]=d.useState(!1),{pushKey:s}=Po(),c=()=>{s(e,!0),i(!0)},a=()=>{s(e,!1),i(!1)};return o.jsx("button",{className:`${Mo} ${r?Do:""}`,onMouseDown:c,onMouseUp:a,onMouseLeave:a,onContextMenu:l=>{l.preventDefault(),a()},onPointerDown:c,onPointerUp:a,style:n,children:t})}function Eo(e){const{gamePadStyle:t,gamePadButtonStyle:n,label:r}=e,{control:i,mode:s}=d.useContext(A),c=Object.keys(i).map(a=>{const l=(r==null?void 0:r[a])||a;if(a!=="forward"&&a!=="backward"&&a!=="leftward"&&a!=="rightward")return{tag:a,value:a,name:l}}).filter(a=>a!==void 0).filter(a=>a.tag!=="run");return o.jsx(o.Fragment,{children:s.controller==="clicker"&&o.jsx("div",{className:Oo,style:t,children:c.map((a,l)=>o.jsx(Ao,{value:a.value,name:a.name,gamePadButtonStyle:n},l))})})}var oe={minimap:{position:"absolute",bottom:"20px",left:"20px",width:"200px",height:"200px",zIndex:100,cursor:"pointer"},scale:{position:"absolute",bottom:"20px",left:"230px",zIndex:101,display:"flex",alignItems:"center",gap:"0.5rem",color:"white",fontSize:"1rem",fontFamily:"'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif",fontWeight:"400",background:"rgba(0,0,0,0.5)",padding:"0.5rem 1rem",borderRadius:"1rem"},plusMinus:{cursor:"pointer",width:"2rem",height:"2rem",display:"flex",justifyContent:"center",alignItems:"center",borderRadius:"50%",background:"rgba(0,0,0,0.5)",fontFamily:"'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif",fontWeight:"500",transition:"all 0.2s",":hover":{background:"rgba(0,0,0,0.7)"}}},Rt={color:"white",fontSize:"1.5rem"},_o={background:"rgba(0,0,0,0.3)"},kt={background:"#01fff7",boxShadow:"0 0 10px rgba(1,255,247,0.7)"},Pt={color:"white",fontSize:"1rem"},M=200;const No=.5,zo=.1,To=2;function Io({scale:e=No,minScale:t=zo,maxScale:n=To,blockScale:r=!1,blockScaleControl:i=!1,blockRotate:s=!1,angle:c=0,minimapStyle:a,minimapInnerStyle:l,textStyle:u,minimapObjectStyle:h,avatarStyle:f,scaleStyle:p,directionStyle:g,plusMinusStyle:b,imageStyle:y}){const{minimap:R,activeState:D,mode:z}=d.useContext(A),[N,I]=F.useState(e),Y=d.useRef(null),L=d.useCallback(()=>{r||I(w=>Math.min(n,w+.1))},[r,n]),x=d.useCallback(()=>{r||I(w=>Math.max(t,w-.1))},[r,t]),S=d.useCallback(w=>{r||(w.deltaY<0?L():x())},[r,L,x]),v=d.useCallback(()=>s||z.control==="normal"?180:D.euler.y*180/Math.PI+180,[s,z.control,D.euler.y]);return d.useEffect(()=>{const w=Y.current;if(!w||!(D!=null&&D.position)||!(R!=null&&R.props))return;const m=w.getContext("2d");if(!m)return;m.clearRect(0,0,M,M),m.save(),m.beginPath(),m.arc(M/2,M/2,M/2,0,Math.PI*2),m.clip(),m.fillStyle="rgba(0, 0, 0, 0.6)",m.fillRect(0,0,M,M);const j=v();m.translate(M/2,M/2),m.rotate(j*Math.PI/180),m.translate(-200/2,-200/2),(()=>{m.save(),m.fillStyle=(g==null?void 0:g.color)||Rt.color,m.font=`${(g==null?void 0:g.fontSize)||Rt.fontSize} sans-serif`,[{text:"N",x:M/2,y:30},{text:"S",x:M/2,y:M-30},{text:"E",x:M-30,y:M/2},{text:"W",x:30,y:M/2}].forEach(({text:U,x:B,y:P})=>{m.save(),m.translate(B,P),m.rotate(-j*Math.PI/180),m.textAlign="center",m.textBaseline="middle",m.fillText(U,0,0),m.restore()}),m.restore()})(),Object.values(R.props).forEach((_,U)=>{const{center:B,size:P,text:q}=_,H=(B.x-D.position.x)*(c?Math.sin(c):1)*N,ne=(B.z-D.position.z)*(c?-Math.cos(c):1)*N;m.save(),m.fillStyle=(h==null?void 0:h.background)||_o.background;const ye=P.x*N,ve=P.z*N,st=M/2-H-ye/2,at=M/2-ne-ve/2;m.fillRect(st,at,ye,ve),q&&(m.save(),m.fillStyle=(u==null?void 0:u.color)||Pt.color,m.font=`${(u==null?void 0:u.fontSize)||Pt.fontSize} sans-serif`,m.translate(st+ye/2,at+ve/2),s||z.control==="normal"?m.rotate(Math.PI):m.rotate(-j*Math.PI/180),m.textAlign="center",m.textBaseline="middle",m.fillText(q,0,0),m.restore()),m.restore()}),m.save(),m.fillStyle=(f==null?void 0:f.background)||kt.background,m.shadowColor=(f==null?void 0:f.boxShadow)||kt.boxShadow,m.shadowBlur=10,m.beginPath(),m.arc(M/2,M/2,6,0,Math.PI*2),m.fill(),m.restore(),m.restore()},[R,D,N,c,s,z.control,v,h,u,f,g]),o.jsxs("div",{children:[o.jsx("canvas",{ref:Y,width:M,height:M,style:{...oe.minimap,...a},onWheel:S}),!i&&o.jsxs("div",{style:{...oe.scale,...p},children:[o.jsx("div",{style:{...oe.plusMinus,cursor:r?"default":"pointer",...b},onClick:x,children:"+"}),o.jsxs("span",{children:["SCALE 1:",Math.round(100/N)]}),o.jsx("div",{style:{...oe.plusMinus,cursor:r?"default":"pointer",...b},onClick:L,children:"-"})]})]})}C(),K(),C();function Ot({children:e,...t}){const n=d.useRef(),[r,i]=d.useState(),s=new Z;return pe(c=>{const a=c.camera.position.distanceTo(n.current.getWorldPosition(s))<=10;a!==r&&i(a)}),o.jsx("group",{ref:n,children:o.jsx(dn,{transform:!0,occlude:!0,...t,children:e})})}const Mt=new WeakMap;function Fo(e,t){const n=Xe(),r=Lo(n);for(const[i,s]of e)r.has(i)||(r.add(i),n.set(i,s))}const Lo=e=>{let t=Mt.get(e);return t||(t=new WeakSet,Mt.set(e,t)),t};function Uo(e,t){switch(t.type){case"init":return{...e};case"update":return{...e,...t.payload}}}function Go(e){const t=d.useMemo(()=>({activeState:{...T.activeState,position:e.startPosition||T.activeState.position},cameraOption:{...T.cameraOption,...e.cameraOption||{}},mode:{...T.mode,...e.mode||{}},urls:{...T.urls,...e.urls||{}},refs:null,states:T.states,rideable:T.rideable,minimap:T.minimap,control:T.control,clicker:T.clicker,clickerOption:{...T.clickerOption,...e.clickerOption||{}},animationState:T.animationState,block:{...T.block,...e.block||{}},sizes:T.sizes}),[e.startPosition,e.cameraOption,e.mode,e.urls,e.clickerOption,e.block]),[n,r]=d.useReducer(Uo,t);return{gaesupProps:d.useMemo(()=>({value:n,dispatch:r}),[n,r])}}function Xo({initialValues:e,children:t}){return Fo([[We,e.activeState],[Ze,e.mode],[Ke,e.urls],[Ye,e.states],[qe,e.minimap],[Ve,e.control],[$e,e.refs],[Je,e.animationState],[He,e.cameraOption],[Qe,e.clickerOption],[et,e.clicker],[tt,e.rideable],[nt,e.sizes],[rt,e.block]]),o.jsx(o.Fragment,{children:t})}function Bo(e){const{gaesupProps:t}=Go(e);return o.jsx(cr,{children:o.jsx(Xo,{initialValues:t.value,children:e.children})})}function Wo(){const e=d.useContext(A);return{state:e.activeState,mode:e.mode,urls:e.urls,currentAnimation:e.mode.type?e.animationState[e.mode.type].current:"idle"}}function Zo(e){var t=e.match(/^var\((.*)\)$/);return t?t[1]:e}function Dt(e,t){var n={};{var r=e;for(var i in r){var s=r[i];s!=null&&(n[Zo(i)]=s)}}return Object.defineProperty(n,"toString",{value:function(){return Object.keys(this).map(a=>"".concat(a,":").concat(this[a])).join(";")},writable:!1}),n}var Ko="_1kpnjzy0 dsxi6zhi dsxi6zib",Yo="_1kpnjzy1 dsxi6zhi",qo="_1kpnjzy2 dsxi6zli dsxi6zmb dsxi6z0";const ie=({children:e,ToolTip:t,onClick:n,id:r,toolTipStyles:i,iconStyle:s})=>{const[c,a]=d.useState(!0);return o.jsxs("div",{className:Ko,onMouseOver:()=>a(!1),onMouseLeave:()=>a(!0),onClick:l=>{n&&n(l)},style:Dt({...s}),id:r,children:[o.jsx("div",{className:Yo,children:e}),o.jsx("div",{className:qo,style:Dt({opacity:c?"0":"1",...i}),children:t})]})};function Vo(e,t){if(typeof e!="object"||!e)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var r=n.call(e,t);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function $o(e){var t=Vo(e,"string");return typeof t=="symbol"?t:String(t)}function Jo(e,t,n){return t=$o(t),t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function At(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Et(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?At(Object(n),!0).forEach(function(r){Jo(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):At(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}function _t(e,t){var n={};for(var r in e)n[r]=t(e[r],r);return n}var Ho=(e,t,n)=>{for(var r of Object.keys(e)){var i;if(e[r]!==((i=t[r])!==null&&i!==void 0?i:n[r]))return!1}return!0},on=e=>{var t=n=>{var r=e.defaultClassName,i=Et(Et({},e.defaultVariants),n);for(var s in i){var c,a=(c=i[s])!==null&&c!==void 0?c:e.defaultVariants[s];if(a!=null){var l=a;typeof l=="boolean"&&(l=l===!0?"true":"false");var u=e.variantClassNames[s][l];u&&(r+=" "+u)}}for(var[h,f]of e.compoundVariants)Ho(h,i,e.defaultVariants)&&(r+=" "+f);return r};return t.variants=()=>Object.keys(e.variantClassNames),t.classNames={get base(){return e.defaultClassName.split(" ")[0]},get variants(){return _t(e.variantClassNames,n=>_t(n,r=>r.split(" ")[0]))}},t},Qo="_2h59lt0",W=on({defaultClassName:"_2h59lt6",variantClassNames:{selected:{true:"_2h59lt7",false:"_2h59lt8"}},defaultVariants:{},compoundVariants:[]}),se="_2h59lt9",ei="_2h59lta",ti="_2h59ltb",ni="_2h59ltc",ri="_2h59ltd",oi="_2h59lte",Pe="_2h59ltf",V="_2h59ltg",Nt="_2h59lth",ii="_2h59ltj",si="_2h59ltk",ai="_2h59ltl";const ee={firstPerson:{yDistance:1.6,fov:75,smoothing:{position:.1,rotation:.1,fov:.05}},thirdPerson:{xDistance:15,yDistance:8,zDistance:15,enableCollision:!0,smoothing:{position:.08,rotation:.1,fov:.1},bounds:{minY:2,maxY:50}},thirdPersonOrbit:{xDistance:20,yDistance:10,zDistance:20,smoothing:{position:.1,rotation:.15,fov:.1}},topDown:{yDistance:25,xDistance:0,zDistance:0,fov:60,bounds:{minX:-100,maxX:100,minZ:-100,maxZ:100}},sideScroll:{xDistance:-20,yDistance:5,zDistance:0,bounds:{minX:-50,maxX:50,minY:2,maxY:30}}},zt={firstPerson:"캐릭터 눈높이 시점 - 이동하면 머리 흔들림 효과를 볼 수 있어요!",thirdPerson:"충돌 감지 기능이 있는 추적 카메라 - 물체 근처에서 걸어보세요!",thirdPersonOrbit:"캐릭터 중심으로 회전하는 궤도 카메라 - 좌우로 돌려보세요!",topDown:"새가 내려다보는 시점 - 전략 게임이나 전체 맵 보기에 좋아요!",sideScroll:"클래식 2D 플랫폼 게임 시점 - 좌우로 이동해보세요!"};function ci(){var f,p,g,b;const{mode:e,cameraOption:t}=d.useContext(A),n=d.useContext(X),[r,i]=d.useState(!1),s=y=>{n({type:"update",payload:{mode:{...e,type:y,control:"thirdPersonOrbit"}}})},c=y=>{const R=ee[y]||ee[y==="normal"?"thirdPerson":y==="orbit"?"thirdPersonOrbit":"thirdPerson"];n({type:"update",payload:{mode:{...e,control:y},cameraOption:{...t,...R}}})},a=(y,R)=>{n({type:"update",payload:{cameraOption:{...t,[y]:R}}})},l=(y,R)=>{n({type:"update",payload:{cameraOption:{...t,smoothing:{...t.smoothing,[y]:R}}}})},u=()=>{const y=e.control,R=ee[y]||ee[y==="normal"?"thirdPerson":y==="orbit"?"thirdPersonOrbit":"thirdPerson"];n({type:"update",payload:{cameraOption:{...t,...R}}})},h=()=>{const y=e.control;return(zt[y]||zt[y==="normal"?"thirdPerson":y==="orbit"?"thirdPersonOrbit":"thirdPerson"])+" (WASD/Arrow Keys + Mouse Click)"};return o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:Qo,children:[o.jsx(ie,{ToolTip:o.jsxs(o.Fragment,{children:[o.jsx("p",{className:W({selected:e.type==="character"}),onClick:()=>s("character"),children:"character"}),o.jsx("p",{className:W({selected:e.type==="vehicle"}),onClick:()=>s("vehicle"),children:"vehicle"}),o.jsx("p",{className:W({selected:e.type==="airplane"}),onClick:()=>s("airplane"),children:"airplane"})]}),toolTipStyles:{background:"rgba(0,0,0,0.8)"},children:o.jsx("button",{className:se,children:e.type})}),o.jsx(ie,{ToolTip:o.jsxs(o.Fragment,{children:[o.jsx("p",{className:W({selected:e.control==="firstPerson"}),onClick:()=>c("firstPerson"),children:"🎯 firstPerson"}),o.jsx("p",{className:W({selected:e.control==="thirdPerson"||e.control==="normal"}),onClick:()=>c("thirdPerson"),children:"📷 thirdPerson"}),o.jsx("p",{className:W({selected:e.control==="thirdPersonOrbit"||e.control==="orbit"}),onClick:()=>c("thirdPersonOrbit"),children:"🔄 thirdPersonOrbit"}),o.jsx("p",{className:W({selected:e.control==="topDown"}),onClick:()=>c("topDown"),children:"🗺️ topDown"}),o.jsx("p",{className:W({selected:e.control==="sideScroll"}),onClick:()=>c("sideScroll"),children:"📖 sideScroll"})]}),toolTipStyles:{background:"rgba(0,0,0,0.8)"},children:o.jsx("button",{className:se,children:e.control})}),o.jsx(ie,{ToolTip:o.jsx(o.Fragment,{children:o.jsx("p",{className:W({selected:!0}),children:"🎮 Hybrid Control (Keyboard + Mouse)"})}),toolTipStyles:{background:"rgba(0,0,0,0.8)"},children:o.jsx("button",{className:se,children:"🎮 Hybrid"})}),o.jsx(ie,{ToolTip:o.jsx(o.Fragment,{children:"Camera Settings"}),toolTipStyles:{background:"rgba(0,0,0,0.8)"},children:o.jsx("button",{className:se,onClick:()=>i(!r),children:"⚙️"})})]}),o.jsx("div",{className:ei,children:h()}),r&&o.jsxs("div",{className:ti,children:[o.jsxs("div",{className:ni,children:[o.jsxs("h3",{children:["Camera Settings - ",e.control]}),o.jsx("button",{onClick:u,className:ri,children:"Reset to Preset"})]}),o.jsxs("div",{className:oi,children:[o.jsxs("div",{className:Pe,children:[o.jsx("label",{children:"Distance"}),o.jsxs("div",{className:V,children:[o.jsx("span",{children:"X:"}),o.jsx("input",{type:"range",min:"-50",max:"50",step:"1",value:t.xDistance??t.XDistance??0,onChange:y=>a("xDistance",Number(y.target.value))}),o.jsx("span",{children:t.xDistance??t.XDistance??0})]}),o.jsxs("div",{className:V,children:[o.jsx("span",{children:"Y:"}),o.jsx("input",{type:"range",min:"0",max:"50",step:"1",value:t.yDistance??t.YDistance??0,onChange:y=>a("yDistance",Number(y.target.value))}),o.jsx("span",{children:t.yDistance??t.YDistance??0})]}),o.jsxs("div",{className:V,children:[o.jsx("span",{children:"Z:"}),o.jsx("input",{type:"range",min:"-50",max:"50",step:"1",value:t.zDistance??t.ZDistance??0,onChange:y=>a("zDistance",Number(y.target.value))}),o.jsx("span",{children:t.zDistance??t.ZDistance??0})]})]}),o.jsxs("div",{className:Pe,children:[o.jsx("label",{children:"FOV & Smoothing"}),o.jsxs("div",{className:V,children:[o.jsx("span",{children:"FOV:"}),o.jsx("input",{type:"range",min:"30",max:"120",step:"5",value:t.fov??75,onChange:y=>a("fov",Number(y.target.value))}),o.jsxs("span",{children:[t.fov??75,"°"]})]}),o.jsxs("div",{className:V,children:[o.jsx("span",{children:"Position:"}),o.jsx("input",{type:"range",min:"0.01",max:"1",step:"0.01",value:((f=t.smoothing)==null?void 0:f.position)??.1,onChange:y=>l("position",Number(y.target.value))}),o.jsx("span",{children:(((p=t.smoothing)==null?void 0:p.position)??.1).toFixed(2)})]}),o.jsxs("div",{className:V,children:[o.jsx("span",{children:"Rotation:"}),o.jsx("input",{type:"range",min:"0.01",max:"1",step:"0.01",value:((g=t.smoothing)==null?void 0:g.rotation)??.1,onChange:y=>l("rotation",Number(y.target.value))}),o.jsx("span",{children:(((b=t.smoothing)==null?void 0:b.rotation)??.1).toFixed(2)})]})]}),o.jsxs("div",{className:Pe,children:[o.jsx("label",{children:"Options"}),o.jsxs("div",{className:Nt,children:[o.jsx("input",{type:"checkbox",checked:t.enableCollision??!1,onChange:y=>a("enableCollision",y.target.checked)}),o.jsx("span",{children:"Enable Collision"})]}),o.jsxs("div",{className:Nt,children:[o.jsx("input",{type:"checkbox",checked:t.focus??!1,onChange:y=>a("focus",y.target.checked)}),o.jsx("span",{children:"Focus Mode"})]})]})]}),o.jsxs("div",{className:ii,children:[o.jsx("h4",{children:"Quick Presets:"}),o.jsx("div",{className:si,children:Object.keys(ee).map(y=>o.jsx("button",{className:ai,onClick:()=>c(y),children:y},y))})]})]})]})}function li(){const e=[k(10,0,10)];for(let t=-10;t<=10;t+=30)for(let n=-10;n<=10;n+=30)e.push(k(t,0,n));return Wo(),o.jsxs(o.Fragment,{children:[o.jsx(po,{position:k(10,0,0),rotation:K(),url:"gltf/ally_body.glb",currentAnimation:"jump",rigidbodyType:"fixed",isNotColliding:!0,parts:[{url:"gltf/ally_cloth_rabbit.glb",color:"red"}]}),o.jsx(xo,{position:k(20,0,0),rotation:K(),url:me+"/gaebird.glb",currentAnimation:"idle",rigidbodyType:"fixed",isNotColliding:!0}),o.jsx("group",{visible:!1,children:o.jsx(mo,{position:k(30,0,0),rotation:K(),url:me+"/gaebird.glb",currentAnimation:"idle",rigidbodyType:"fixed",isNotColliding:!0})})]})}function ui(){return o.jsxs(o.Fragment,{children:[o.jsx(fn,{renderOrder:-1,position:[0,.2,0],infiniteGrid:!0,cellSize:2,cellThickness:1,cellColor:"#1d1d1d",sectionSize:5,sectionThickness:0,fadeDistance:1e3,userData:{intangible:!0}}),o.jsxs(Ft,{type:"fixed",userData:{intangible:!0},children:[o.jsx("mesh",{receiveShadow:!0,position:[0,-1,0],children:o.jsx("boxGeometry",{args:[1e3,2,1e3]})}),o.jsx(Ro,{type:"ground",children:o.jsxs("mesh",{receiveShadow:!0,position:[0,.1,0],rotation:[-Math.PI/2,0,0],children:[o.jsx("planeGeometry",{args:[1e3,1e3]}),o.jsx("meshStandardMaterial",{color:"#3d3d3d"})]})})]})]})}var di="wvg6fc4 dsxi6z82 dsxi6z89",fi="wvg6fc6 dsxi6z82 dsxi6z88",hi="wvg6fc7 dsxi6z82 dsxi6z89";on({defaultClassName:"wvg6fcb",variantClassNames:{control:{true:"wvg6fcc"}},defaultVariants:{},compoundVariants:[]});var mi="wvg6fcd dsxi6z82 dsxi6z88",pi="wvg6fcf",xi="wvg6fcg",Oe="wvg6fch";function gi({radius:e=2.75,speed:t=6,...n}){const r=d.useRef();return pe(i=>{const s=i.clock.getElapsedTime()*t;r.current&&r.current.position.set(Math.sin(s)*e,Math.cos(s)*e*Math.atan(s)/Math.PI/1.25,0)}),o.jsx("group",{...n,children:o.jsx(mn,{local:!0,width:5,length:6,color:new vn(2,1,10),attenuation:i=>i*i,children:o.jsxs("mesh",{ref:r,children:[o.jsx("sphereGeometry",{args:[.25]}),o.jsx("meshBasicMaterial",{color:[10,1,10],toneMapped:!1})]})})})}function yi(){return o.jsxs(o.Fragment,{children:[o.jsxs("mesh",{position:[10,2,0],castShadow:!0,children:[o.jsx("boxGeometry",{args:[2,4,2]}),o.jsx("meshStandardMaterial",{color:"orange"})]}),o.jsxs("mesh",{position:[-10,1.5,5],castShadow:!0,children:[o.jsx("cylinderGeometry",{args:[1,1,3]}),o.jsx("meshStandardMaterial",{color:"cyan"})]}),o.jsxs("mesh",{position:[0,1,15],castShadow:!0,children:[o.jsx("sphereGeometry",{args:[2]}),o.jsx("meshStandardMaterial",{color:"purple"})]}),o.jsxs("mesh",{position:[20,1,-10],castShadow:!0,children:[o.jsx("coneGeometry",{args:[2,4]}),o.jsx("meshStandardMaterial",{color:"green"})]}),o.jsxs("mesh",{position:[-15,2,-8],castShadow:!0,children:[o.jsx("dodecahedronGeometry",{args:[2]}),o.jsx("meshStandardMaterial",{color:"red"})]})]})}const me="https://jiggloghttps.s3.ap-northeast-2.amazonaws.com/gltf";function vi(){const e="gltf/ally_body.glb",t=me+"/gaebird.glb",n=me+"/gorani.glb";return o.jsxs(Bo,{urls:{characterUrl:e,vehicleUrl:n,airplaneUrl:t},mode:{type:"character",controller:"keyboard",control:"thirdPerson"},debug:!1,cameraOption:{xDistance:15,yDistance:8,zDistance:15,enableCollision:!0,smoothing:{position:.08,rotation:.1,fov:.1},fov:75,bounds:{minY:2,maxY:50,minX:-100,maxX:100,minZ:-100,maxZ:100}},children:[o.jsxs(cn,{shadows:!0,dpr:[1,2],camera:{position:[0,10,20],fov:75,near:.1,far:1e3},style:{width:"100vw",height:"100vh",position:"fixed"},frameloop:"demand",children:[o.jsx(hn,{background:!0,preset:"sunset",backgroundBlurriness:1}),o.jsx("directionalLight",{castShadow:!0,"shadow-normalBias":.06,position:[20,30,10],intensity:.5,"shadow-mapSize":[1024,1024],"shadow-camera-near":1,"shadow-camera-far":50,"shadow-camera-top":50,"shadow-camera-right":50,"shadow-camera-bottom":-50,"shadow-camera-left":-50}),o.jsx("directionalLight",{castShadow:!0,"shadow-normalBias":.06,position:[-200,30,-100],intensity:.7,"shadow-mapSize":[5e3,5e3],"shadow-camera-near":1,"shadow-camera-far":50,"shadow-camera-top":50,"shadow-camera-right":50,"shadow-camera-bottom":-50,"shadow-camera-left":-50}),o.jsx(d.Suspense,{children:o.jsxs(gn,{debug:!0,interpolate:!0,children:[o.jsx(jo,{onAnimate:({control:r,subscribe:i})=>{i({tag:"greet",condition:()=>r==null?void 0:r.keyZ})},controllerOptions:{lerp:{cameraTurn:.1,cameraPosition:.08}},rigidBodyProps:{},parts:[{url:"gltf/ally_cloth_rabbit.glb",color:"#ffe0e0"}]}),o.jsx(ui,{}),o.jsx(yi,{}),o.jsx(li,{}),o.jsx(gi,{}),o.jsx(ko,{onMarker:o.jsx("group",{rotation:K({x:0,y:Math.PI/2,z:0}),children:o.jsx(Ot,{position:k(0,1,0),children:o.jsx(dt,{style:{color:"#f4ffd4",fontSize:"5rem"}})})}),runMarker:o.jsx(Ot,{position:k(0,1,0),children:o.jsx(dt,{style:{color:"#ffac8e",fontSize:"5rem"}})})})]})})]}),o.jsx(ci,{}),o.jsxs("div",{className:pi,children:[o.jsx("h3",{children:"카메라 데모 조작법"}),o.jsxs("div",{className:xi,children:[o.jsxs("div",{className:Oe,children:[o.jsx("h4",{children:"카메라 모드:"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"1인칭:"})," 캐릭터 눈으로 보는 시점"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"3인칭:"})," 충돌 감지가 있는 뒤따라가기 카메라"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"3인칭 궤도:"})," 캐릭터 주변을 도는 카메라"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"탑다운:"})," 전략 게임용 위에서 내려다보는 시점"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"사이드 스크롤:"})," 클래식 2D 플랫폼 게임 스타일"]})]})]}),o.jsxs("div",{className:Oe,children:[o.jsx("h4",{children:"조작법:"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"🎮 하이브리드 조작:"})," 키보드와 마우스 동시 사용 가능!"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"W/↑:"})," 앞으로 이동"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"S/↓:"})," 뒤로 이동"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"A/←:"})," 왼쪽으로 이동"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"D/→:"})," 오른쪽으로 이동"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"🖱️ 마우스 클릭:"})," 바닥 클릭으로 이동"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"스페이스:"})," 점프"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Shift:"})," 달리기 (이동 중에 누르기)"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Z:"})," 인사"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"R:"})," 탑승 (차량 근처에서)"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"F:"})," 상호작용"]}),o.jsxs("li",{children:[o.jsx("strong",{children:"E:"})," 사용"]})]})]}),o.jsxs("div",{className:Oe,children:[o.jsx("h4",{children:"테스트 기능:"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"컨트롤러 전환:"})," 클리커와 키보드 모드 체험"]}),o.jsx("li",{children:"카메라 충돌 감지 (3인칭)"}),o.jsx("li",{children:"모드 간 부드러운 전환"}),o.jsx("li",{children:"시야각(FOV) 조정"}),o.jsx("li",{children:"경계 제한"}),o.jsx("li",{children:"실시간 설정 조정 (⚙️ 버튼)"})]})]})]})]}),o.jsx("div",{className:fi,children:o.jsx("div",{className:mi,children:o.jsx(Eo,{label:{keyZ:"GREET",shift:"SPRINT",space:"JUMP"}})})}),o.jsx("div",{className:hi,children:o.jsx("div",{className:di,children:o.jsx(Io,{})})})]})}function bi(){return o.jsx(vi,{})}pn.createRoot(document.getElementById("root")).render(o.jsx(F.StrictMode,{children:o.jsx(bi,{})}));
