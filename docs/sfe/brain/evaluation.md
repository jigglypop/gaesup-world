## 제4장 평가 프로토콜: self-play 기반 성공 판정과 재현성

> 본 문서는 **LB-IGD (Laplace–Beltrami Inverse Game Design)** 관련 이론 문서입니다. (구현 코드: 미포함)
>
> - 관련 문서: 제1장 `docs/brain/bellman.md`, 제2장 `docs/brain/lbo.md`, 제3장 `docs/brain/blackbox.md`
> - 코드 대응: (미포함)

### 초록
제1장과 제3장은 “설계 \(x\)가 게임 \(\mathcal{M}_x\)를 만들고, self-play/RL로 얻는 관측 통계 \(y(x;\omega)\)로 외부 목적 \(J(x)\)를 줄인다”는 bilevel/black-box 구조를 정리했습니다. 제2장은 그 과정에서 곡률/확산(라플라시안, LBO) 관점이 왜 자연스럽게 등장하는지를 수학적으로 연결합니다.

하지만 실제로 “이 설계가 좋은가?”를 말하려면 **평가 방법 자체를 먼저 고정**해야 합니다. 학습 예산, 매칭 구성, 시드 반복 같은 조건이 바뀌면 같은 \(x\)라도 결과 분포가 달라지기 때문입니다. 이 장은 그 고정 규칙(평가 프로토콜)과 성공 판정 기준을 설명합니다.

이 장에서 다루는 내용은 다음입니다.

- (i) self-play 평가를 재현 가능하게 만들기 위한 최소 프로토콜(고정해야 할 것들)
- (ii) **승률 기반 밸런스 지표**를 중심으로 한 성공 판정식
- (iii) 노이즈/퇴화 해(degenerate solution)를 배제하기 위한 제약과 강건성(시드 민감도) 체크

분포 기반 메타 지표는 “승률을 보조하는 선택적 지표”로 다룹니다(예: 퇴화 해 탐지, 해석 가능성 강화).



### 1. “성공”은 승률만이 아니라, 고정된 프로토콜에서의 목적 $J(x)$ 달성이다
설계의 품질은 “동일한 평가 절차”를 통해 얻는 통계로만 정의되어야 합니다. 평가 절차(학습 예산, 매칭 구성, 시드, 초기화)가 바뀌면 \(y(x;\omega)\)의 분포도 달라지므로, 서로 다른 \(x\)를 공정하게 비교하려면 아래 항목을 **명시적으로 고정**해야 합니다.

- 내부 학습 예산 $B$(학습 시간/스텝/게임 수)
- 정책 초기화 방식(항상 재학습 vs warm-start)
- 매칭 구성(라운드로빈, 리그, 대칭 매칭 등)
- 시드 및 반복 수 $S$

이 장에서 말하는 “성공”은 다음을 의미합니다.

- 동일한 예산 $B$와 동일한 프로토콜에서,
- **승률 기반 밸런스 지표가 개선되고,**
- 퇴화 해를 배제하는 제약을 만족하며,
- 시드 변화에 대한 결과 분산이 충분히 작다.

## 2. 승률 기반 밸런스: 2팩션(체스형)과 다팩션을 분리해 정의하기

## 2.1 2팩션인 경우(체스처럼 1:1 대전)
2팩션(또는 “두 진영만 비교”)일 때 가장 단순한 성공 기준은

$$
W(x) \approx 0.5
$$

이다. 다만 $W(x)$는 내부 학습의 수렴/노이즈에 영향을 받으므로, 단일 추정치가 아니라 시드 반복에 대한 평균과 분산으로 기록한다.

$$
\hat W(x)=\frac{1}{S}\sum_{s=1}^{S} W(x;\omega_s),
\qquad
\widehat{\mathrm{Var}}[W(x)] = \frac{1}{S-1}\sum_{s=1}^{S}\big(W(x;\omega_s)-\hat W(x)\big)^2.
$$

#### 2.2 $F$팩션인 경우(메타 전체 밸런스)
다팩션에서는 승률을 스칼라로 요약하면 정보가 손실된다. 따라서 쌍대결 승률행렬을

$$
W_{f,g}(x;\omega)\in[0,1],\qquad f\neq g
$$

로 두고, 목표를 $0.5$ 근처로 평탄화한다. 예를 들어 다음 손실은 “쌍대결 편향”을 직접 측정한다.

$$
L_{\text{pair}}(x;\omega)=\frac{1}{F(F-1)}\sum_{f\neq g}\big(W_{f,g}(x;\omega)-0.5\big)^2.
$$

또는 팩션별 평균 승률 $W_f(x;\omega)$를 쓰고자 하면(제1장 방식),

$$
L_{\text{win}}(x;\omega)=\sum_{f=1}^{F}\big(W_f(x;\omega)-\tfrac{1}{F}\big)^2
$$

를 사용할 수 있다. 어느 쪽이든 “승률만”을 성공 기준으로 둘 경우 퇴화 해가 가능하므로(4절) 제약/분포 지표를 함께 둔다.

### 2.3 구현 관점에서의 “다팩션 평가”를 고정하는 방법(권장)
다팩션 목표는 “모든 팩션 쌍이 서로에게 50:50에 가깝게”이다. 이를 구현할 때 중요한 것은 **평가 프로토콜을 후보 설계 간 동일하게 고정**하는 것이다.

#### (A) 평가 단위는 ‘1:1 쌍대결’로 고정한다
본 프로젝트의 다팩션 평가는 $F$팩션 전체가 동시에 난전하는 형태가 아니라, **모든 쌍 $(f,g)$에 대해 1:1 대전을 수행**하고 이를 집계한다.

이때 승률행렬은 보통 다음 의미를 갖는다.

- $W_{f,g}$: “$f$가 $g$와 1:1로 싸울 때 $f$의 승률”
- 따라서 $W_{f,g} + W_{g,f} \approx 1$ (무승부가 없다면)

#### (B) 선턴 공정성은 ‘쌍대결마다 반반’으로 강제한다
턴제 환경에서는 선턴 유불리가 생길 수 있으므로, 각 쌍대결 $(f,g)$에 대해 평가 에피소드를 절반으로 나누어

- 앞 절반: $f$가 선턴
- 뒤 절반: $g$가 선턴

으로 **반반 분배를 고정**한다. “랜덤 선턴”은 표본 수가 작을 때 편향이 커질 수 있으므로, 프로토콜을 명확히 하는 목적에서는 반반 고정이 더 적합하다.

#### (C) 시드 규칙을 명시하여 재현성과 비교 공정성을 확보한다
다팩션에서 모든 쌍을 평가할 때는, 쌍마다 시드를 다르게 주되 “후보 설계 간에는 동일 규칙”으로 생성하는 것이 좋다(공통 난수, CRN).

예:

- 기본 시드 $s$
- 쌍대결 $(i,j)$ 시드: $s_{i,j} = s + 1000\cdot i + j$

이 규칙을 고정하면, 후보 설계 간 비교에서 “우연히 좋은 매칭이 걸린 효과”를 줄일 수 있습니다.

---

### 3. (선택) 보조 메타 지표: 교전 거리 분포의 정합
승률 평탄화만으로는 설계가 “재미 없는 50:50”으로 퇴화하는 경우가 있으므로, 보조 지표로 플레이 패턴(예: 교전 거리 분포)을 함께 관찰할 수 있습니다. 제3장처럼 교전 거리의 경험분포 \(\hat p_x(\cdot;\omega)\)를 구성하고, 목표 메타 \(q^\star\)와의 거리를 측정합니다. 1차원 경험분포 간 \(W_2\)는 정렬 기반으로 계산할 수 있습니다.

표본 $\{d_i\}_{i=1}^{N}\sim \hat p_x(\cdot;\omega)$, $\{\tilde d_i\}_{i=1}^{N}\sim q^\star$를 각각 정렬해 $d_{(i)}, \tilde d_{(i)}$라 하면,

$$
W_2^2(\hat p_x(\cdot;\omega), q^\star)\approx \frac{1}{N}\sum_{i=1}^{N}\big(d_{(i)}-\tilde d_{(i)}\big)^2.
$$

이 값이 작아지는 것은 “승패 결과”가 아니라 “플레이 패턴(거리대의 리듬)”이 목표 메타에 가까워졌음을 의미합니다.

> 구현 메모: (미포함) 1차원 경험표본에 대해 위의 형태로 \(W_2^2\)를 근사한다.

---

### 4. 퇴화 해(degenerate solution) 방지: 반드시 제약/검증 지표를 둔다
승률 평탄화 또는 분포 정합만을 최소화하면, 의미 없는 최적해가 선택될 수 있다. 예시는 다음과 같다.

- 교전 자체가 거의 발생하지 않도록 설계하여 거리 분포가 의미를 잃는 경우
- 극단적으로 긴/짧은 게임 길이로 통계의 분산이 인위적으로 감소하는 경우

따라서 평가에는 최소한 다음 제약 지표를 포함한다.

- 교전 이벤트 발생률 하한(예: 게임당 교전 이벤트 수 $\ge c_{\min}$)
- 게임 길이 범위(예: 평균 길이 $\in [T_{\min},T_{\max}]$)
- 무승부/정지 상태 비율 상한(해당 규칙이 존재하는 경우)

이를 제약 손실 $R(x;\omega)$로 모으면, 최종 평가지표(추정 목적)는 다음처럼 둘 수 있다. 승률 중심 기본식은 다음과 같다.

$$
\hat J(x)
:=
\frac{1}{S}\sum_{s=1}^{S}
\Big(
L_{\text{win}}(x;\omega_s)
+
\beta\,R(x;\omega_s)
\Big).
$$

분포 기반 메타 지표를 보조로 포함하면 다음과 같다.

$$
\hat J_{\text{aux}}(x)
=
\frac{1}{S}\sum_{s=1}^{S}
\Big(
L_{\text{win}}(x;\omega_s)
+
\lambda\,W_2^2(\hat p_x(\cdot;\omega_s), q^\star)
+
\beta\,R(x;\omega_s)
\Big).
$$

---

### 5. self-play 평가 프로토콜(최소 버전)
다음은 “알파고처럼 self-play를 돌려 성공을 판정”하기 위한 최소 프로토콜이다.

#### 5.1 각 설계 $x$에 대한 평가 절차
1) **학습**: 예산 $B$를 고정하고, 시드 $\omega_s$마다 내부(self-play/RL) 학습을 수행해 정책(또는 에이전트)을 만든다.  
2) **매칭**: 고정된 매칭 규칙(라운드로빈/리그/대칭)을 사용해 평가 매치를 수행한다.  
3) **로그 수집**: 승패, 게임 길이, 교전 거리 표본을 수집해 $W(\cdot)$, $\hat p_x$를 계산한다.  
4) **집계**: $s=1,\ldots,S$에 대해 반복 후 $\hat J(x)$를 계산한다(분포 기반 보조 지표를 포함하는 경우 $\hat J_{\text{aux}}(x)$).

#### 5.2 성공 판정(권장 형태)
다음을 동시에 만족하면 성공으로 본다.

- 밸런스: $\max_{f\neq g}\big|\hat W_{f,g}(x)-0.5\big|\le \epsilon_{\text{win}}$
- (선택) 메타: $\frac{1}{S}\sum_s W_2^2(\hat p_x(\cdot;\omega_s), q^\star)\le \epsilon_{\text{meta}}$
- 제약: $\frac{1}{S}\sum_s R(x;\omega_s)\le \epsilon_{\text{con}}$
- 강건성: 시드에 대한 분산(또는 신뢰구간 폭)이 허용 범위 이내

여기서 $\epsilon_{\text{win}},\epsilon_{\text{meta}},\epsilon_{\text{con}}$는 “제출/실험 규모”에 맞게 조정한다.

---

### 6. 구현을 위한 체크리스트(필요 최소 데이터)
구현 단계에서 다음 항목이 산출되면, 본 문서의 평가 지표를 모두 계산할 수 있다.

- 설계 $x$별 self-play 평가 결과: 승자(또는 승패), 대전 페어/팩션 정보
- 교전 이벤트별 교전 거리 $d$
- 게임 길이(스텝/시간) 및 퇴화 여부 판단에 필요한 이벤트 수(교전 횟수 등)
- 시드별 반복 $s=1,\ldots,S$를 구분할 수 있는 식별자

---

### 7. 흔한 실패 원인(해석 지침)
승률이 0.5 근처여도 다음 이유로 “성공 착시”가 발생할 수 있다.

- 학습이 충분히 수렴하지 않아 “둘 다 약해서” 0.5가 되는 경우
- warm-start 설정에서 과거 학습 히스토리가 섞여 시드 독립성이 깨지는 경우
- 매칭 표본이 작아 추정 오차가 큰 경우

따라서 본 장의 강건성/제약 지표를 동시에 확인하는 것이 필수이다.


---

### 8. 검증(verification) 체크리스트: “성공 착시”와 퇴화 해를 배제하기 위한 최소 점검
본 문서의 프로토콜을 적용한 뒤, 다음을 점검하면 “승률 0.5 근처”가 실제 밸런스를 의미하는지 빠르게 검증할 수 있다.

- **프로토콜 고정 확인**: 학습 예산 $B$, 초기화 방식(재학습/warm-start), 매칭 규칙, 시드 반복 수 $S$가 후보 간 동일한가
- **표본 수 확인**: 매칭 수(게임 수)가 충분한가(부족하면 신뢰구간이 커져 성공 착시가 증가)
- **수렴/약자 0.5 배제**: “둘 다 약해서 0.5”가 아닌지(예: 동일 평가 풀/강자 풀과의 교차평가를 추가하거나, 학습 예산을 늘려 성능 상한이 안정화되는지 확인)
- **제약 위반 여부**: 교전 발생률 하한, 게임 길이 범위, 정지/무승부 비율 상한이 만족되는가
- **강건성(시드 민감도)**: $\widehat{\mathrm{Var}}[W]$ 또는 신뢰구간 폭이 허용 범위 이내인가

분포 기반 보조 지표(예: 교전 거리 $W_2$)는 “승률을 보조”하는 용도로 사용하고, 성공 판정은 승률/제약/강건성의 동시 만족으로 둔다.

### 9. 분산 감소(권장): 공통 난수(CRN)와 조기 종료를 프로토콜에 포함하기
외부 최적화(예: ES)를 결합할 때는 `blackbox.md` 13절의 실행 루프를 따르되, 다음을 평가 프로토콜의 일부로 명시하여 고정하면 비용과 분산을 동시에 줄일 수 있다.

- **공통 난수(CRN)**: 동일 반복 $s$에서 후보 설계들에 같은 시드/매칭을 부여해 후보 간 비교 분산을 감소
- **조기 종료**: 제약 위반이 큰 후보는 학습/평가를 즉시 중단하여 퇴화 해를 빠르게 배제
- **멀티-피델리티**: 작은 $B$로 예비 선별 후 상위 후보만 큰 $B$로 확정

warm-start를 사용하는 경우, 히스토리 의존성으로 인해 결과 분포가 바뀔 수 있으므로 “사용 여부/규칙” 자체를 프로토콜에 명시하고 고정해야 한다.

